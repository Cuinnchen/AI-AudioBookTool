# 角色音色配置模型

<cite>
**本文档引用文件**   
- [serverV2.py](file://serverV2.py#L1708-L1725)
- [index.html](file://index.html#L1650-L1677)
</cite>

## 目录
1. [简介](#简介)
2. [数据模型结构](#数据模型结构)
3. [读取与持久化机制](#读取与持久化机制)
4. [在语音生成中的核心作用](#在语音生成中的核心作用)
5. [JSON Schema 与约束](#json-schema-与约束)
6. [使用示例](#使用示例)
7. [角色名合并功能的影响](#角色名合并功能的影响)

## 简介
`character_timbres.json` 文件是 AI 有声书工具中的核心配置文件之一，存储于每个小说项目目录下。该文件用于维护角色名称与音色名称之间的映射关系，是实现个性化语音合成的关键。前端通过 `/api/get_config` 和 `/api/update_config` API 与该文件进行交互，用户可以在界面中为角色分配音色，配置将被持久化保存。TTS 合成接口 `tts_v2` 会根据此映射决定使用哪个音色进行语音生成。

## 数据模型结构
`character_timbres.json` 文件采用简单的键值对（Key-Value）对象结构。
- **键（Key）**：字符串类型，代表角色的名称（如 "张三"、"旁白"）。
- **值（Value）**：字符串类型，代表音色的名称（如 "male_narrator_01"）。

该音色名称必须与 `wav/` 目录下的子目录名完全一致，因为系统会根据此名称在 `wav/{timbre_name}/` 路径下查找参考音频（`1.wav`）和参考文本（`1.txt`）。

## 读取与持久化机制
该模型的读取与持久化通过 `serverV2.py` 中的两个 API 实现：
1.  **读取配置 (`/api/get_config`)**：前端在加载项目时，会调用此 API。后端会检查指定小说项目目录下是否存在 `character_timbres.json` 文件。如果存在，则返回该文件内容；如果不存在，则返回一个空的 JSON 对象 `{}`，表示当前没有配置。
2.  **更新配置 (`/api/update_config`)**：当用户在前端界面中为角色分配或更改音色后，点击保存按钮，前端会将当前的映射关系（一个 JavaScript 对象）通过此 API 发送到后端。后端接收到 `config_data` 后，会将其以格式化的 JSON 形式写入到对应小说项目的 `character_timbres.json` 文件中，从而实现配置的持久化。

**Section sources**
- [serverV2.py](file://serverV2.py#L1708-L1725)
- [index.html](file://index.html#L1650-L1677)

## 在语音生成中的核心作用
`character_timbres.json` 模型是 TTS（Text-to-Speech）合成流程中的决策依据。当系统需要为某一行文本生成语音时，会执行以下逻辑：
1.  获取该行文本的说话者（`speaker`）。
2.  查询 `character_timbres.json` 配置，获取该说话者对应的音色（`timbre`）。
3.  根据获取到的音色名称，定位到 `wav/{timbre}/1.wav` 和 `wav/{timbre}/1.txt` 作为参考。
4.  将文本、参考音频和参考文本等信息打包，发送给 TTS 微服务（如 CosyVoice2）。
5.  TTS 微服务根据参考信息，使用指定音色的声学特征来合成语音。

如果在配置中找不到对应角色的音色，则 TTS 生成会失败。

## JSON Schema 与约束
以下是 `character_timbres.json` 文件的 JSON Schema 定义：

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "patternProperties": {
    "^[\\w\\s\\u4e00-\\u9fff-]+$": {
      "type": "string",
      "pattern": "^[\\w\\s\\u4e00-\\u9fff-]+$"
    }
  },
  "additionalProperties": false,
  "minProperties": 0,
  "maxProperties": 1000,
  "propertyNames": {
    "maxLength": 50
  },
  "properties": {}
}
```

**约束说明：**
- **空对象合法性**：允许为空对象 `{}`，这表示项目尚未进行音色分配。
- **字符编码要求**：键和值均支持 Unicode 字符，包括中文（`\u4e00-\u9fff`）、英文字母、数字、下划线、空格和连字符。不支持特殊符号（如 `/`, `\`, `:`, `*`, `"`, `<`, `>`, `|`）。
- **大小限制**：对象的属性（即角色-音色对）数量上限为 1000 个。单个角色名或音色名的长度上限为 50 个字符。

## 使用示例
为角色“张三”分配音色“male_narrator_01”的操作流程如下：
1.  在前端界面的角色音色管理面板中，选中角色“张三”。
2.  在音色列表中，点击“分配”按钮，并选择“male_narrator_01”音色。
3.  点击“保存配置”按钮。
4.  此时，`serverV2.py` 的 `/api/update_config` 接口会被调用，其 `config_data` 参数内容如下：
    ```json
    {"张三": "male_narrator_01"}
    ```
5.  后端将此数据写入 `projects/{novel_name}/character_timbres.json` 文件。
6.  当后续为“张三”的对话生成语音时，系统将自动使用 `wav/male_narrator_01/` 目录下的参考音频和文本进行合成。

## 角色名合并功能的影响
角色名合并功能会对 `character_timbres.json` 模型产生直接影响，开发者必须注意以下几点：
1.  **键名更新**：当将多个源角色（source_names）合并到一个目标角色（target_name）时，系统会自动更新 `character_timbres.json` 文件。目标角色会继承源角色的音色配置，而源角色的配置条目将被删除。
2.  **智能重命名**：如果源角色和目标角色使用的是同一个音色，系统会尝试智能地重命名已生成的音频文件（例如，将 `0001-张三-male_narrator_01.wav` 重命名为 `0001-李四-male_narrator_01.wav`），从而避免重新生成，提高效率。
3.  **配置继承**：如果目标角色本身没有配置音色，系统会从被合并的源角色中选取一个（通常是第一个）的音色作为目标角色的音色。

因此，在执行角色合并操作后，`character_timbres.json` 文件会被自动清理和更新，确保配置的准确性和一致性。

**Section sources**
- [serverV2.py](file://serverV2.py#L379-L479)