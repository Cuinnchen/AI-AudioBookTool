# 替换词典模型

<cite>
**本文档引用文件**   
- [serverV2.py](file://serverV2.py#L141-L147)
- [serverV2.py](file://serverV2.py#L520-L558)
- [serverV2.py](file://serverV2.py#L1728-L1861)
- [serverV2.py](file://serverV2.py#L1959-L2006)
- [index.html](file://index.html#L734-L756)
- [index.html](file://index.html#L3840-L3947)
</cite>

## 目录
1. [简介](#简介)
2. [数据模型结构](#数据模型结构)
3. [API操作流程](#api操作流程)
4. [在TTS生成中的应用](#在tts生成中的应用)
5. [JSON Schema定义](#json-schema定义)
6. [配置示例](#配置示例)
7. [性能建议](#性能建议)

## 简介
`replace_dict.json` 是一个位于各小说项目目录下的配置文件，用于定义文本预处理时的替换规则。该文件允许用户在文本转语音（TTS）生成前，对原始文本进行自定义的词语替换，以适应特定音色的发音习惯或修正专有名词的发音。此模型与全局配置相互独立，确保了不同小说项目的文本处理规则互不干扰。

**Section sources**
- [serverV2.py](file://serverV2.py#L520-L558)

## 数据模型结构
`replace_dict.json` 文件的核心是一个名为 `rules` 的数组。该数组包含多条替换规则，每条规则是一个JSON对象，其结构如下：

- **original_word** (字符串, 必填): 需要被替换的原始词语。
- **replacement_word** (字符串, 必填): 用于替换原始词语的新词语。
- **description** (字符串, 可选): 对该替换规则的描述，用于说明替换原因或上下文。

例如，一条规则可以将“嗯”替换为“呃”，以使语音输出更符合特定角色的说话习惯。

**Section sources**
- [serverV2.py](file://serverV2.py#L141-L147)

## API操作流程
系统通过 `serverV2.py` 中的 `/api/novel/{novel_name}/replace_dict` 系列API来管理 `replace_dict.json` 文件，支持增、删、改、查等操作。

### 前端加载词典
当用户在前端界面点击“管理替换词典”按钮时，前端会调用 `GET /api/novel/{novel_name}/replace_dict` 接口。后端会检查指定小说项目目录下是否存在 `replace_dict.json` 文件。如果文件不存在，API会返回一个空的 `rules` 数组。如果文件存在但格式错误，API会记录警告并返回空数组。否则，API会返回文件中的完整规则数据，前端据此渲染词典列表。

**Section sources**
- [serverV2.py](file://serverV2.py#L1959-L1980)
- [index.html](file://index.html#L3840-L3869)

### 添加新规则
用户在前端模态框中输入“原词”和“替换为”后，点击“添加规则”按钮。前端会将新规则推入本地状态 `state.replaceDict`，然后调用 `saveReplaceDict()` 函数。该函数会向 `POST /api/novel/{novel_name}/replace_dict` 接口发送一个包含完整 `rules` 数组的请求。后端接收到请求后，会验证每条规则的 `original_word` 和 `replacement_word` 字段是否为空，验证通过后，将整个 `rules` 数组序列化并写入 `replace_dict.json` 文件。

**Section sources**
- [serverV2.py](file://serverV2.py#L1982-L2006)
- [index.html](file://index.html#L3871-L3901)

### 搜索特定规则
前端提供了一个搜索输入框，用户输入关键词后，会触发 `renderReplaceRules()` 函数。该函数会遍历 `state.replaceDict` 数组，根据关键词对 `original_word`、`replacement_word` 和 `description` 字段进行模糊匹配，然后只渲染匹配到的规则，方便用户快速定位。

**Section sources**
- [index.html](file://index.html#L3902-L3947)

### 删除无效规则
用户点击规则列表中的“删除”按钮时，前端会获取该规则的 `original_word` 和 `replacement_word`，并弹出确认对话框。用户确认后，前端会从 `state.replaceDict` 数组中找到并移除该规则，然后调用 `saveReplaceDict()` 函数将更新后的数组持久化到服务器。

**Section sources**
- [index.html](file://index.html#L3899-L3915)

### 持久化到JSON文件
所有对替换词典的修改（添加、删除）最终都通过 `saveReplaceDict()` 函数，以 `POST /api/novel/{novel_name}/replace_dict` 请求的形式，将完整的 `rules` 数组发送到后端。后端的 `update_novel_replace_dict` 函数负责将这些数据写入 `replace_dict.json` 文件，确保了数据的持久化。

**Section sources**
- [serverV2.py](file://serverV2.py#L1982-L2006)

## 在TTS生成中的应用
`replace_dict.json` 模型主要应用于TTS生成前的文本清洗阶段。当系统接收到一个TTS请求时，会调用 `text_to_speech_v2` API。在该API的处理流程中，会首先调用 `apply_replacement_rules` 辅助函数。

该函数会加载指定小说项目的 `replace_dict.json` 文件，获取所有规则。为了确保替换的准确性（例如，避免将“张三”替换为“李三”时，又将“李三”错误地替换为“王三”），规则会按照 `original_word` 的长度进行降序排序。然后，函数会遍历所有规则，使用正则表达式对原始文本 `tts_text` 进行逐条替换。替换完成后，经过清洗的文本才会被发送给TTS微服务进行语音合成。

**Section sources**
- [serverV2.py](file://serverV2.py#L520-L558)
- [serverV2.py](file://serverV2.py#L1728-L1861)

## JSON Schema定义
虽然代码中未显式定义JSON Schema，但根据实现逻辑，可以推断出其约束如下：

```json
{
  "type": "object",
  "properties": {
    "rules": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "original_word": {
            "type": "string",
            "minLength": 1
          },
          "replacement_word": {
            "type": "string",
            "minLength": 1
          },
          "description": {
            "type": "string"
          }
        },
        "required": ["original_word", "replacement_word"]
      },
      "maxItems": 100,
      "uniqueItems": false
    }
  },
  "required": ["rules"]
}
```

- **rules数组最大长度**: 代码中未设置硬性上限，但出于性能考虑，建议限制在100条以内。
- **字符串长度限制**: `original_word` 和 `replacement_word` 的最小长度为1，即不能为空字符串。
- **唯一性约束**: 代码中未强制要求 `original_word` 的唯一性，因此可能存在多条规则针对同一个原词，但后处理时会按长度排序，长词优先，这可能导致短词规则失效。

**Section sources**
- [serverV2.py](file://serverV2.py#L1982-L1997)

## 配置示例
一个典型的 `replace_dict.json` 文件配置示例如下：

```json
{
  "rules": [
    {
      "original_word": "嗯",
      "replacement_word": "呃",
      "description": "使语气更自然，符合角色习惯"
    },
    {
      "original_word": "张真人",
      "replacement_word": "张三丰",
      "description": "修正专有名词，确保发音准确"
    },
    {
      "original_word": "行长",
      "replacement_word": "hang长",
      "description": "避免TTS将'行'读作'xíng'"
    }
  ]
}
```

此配置确保了在生成语音时，“嗯”会被替换为更口语化的“呃”，“张真人”会被标准化为“张三丰”，而“行长”中的“行”字会通过拼音提示被正确读作“hang”。

**Section sources**
- [serverV2.py](file://serverV2.py#L520-L558)

## 性能建议
为确保系统性能，开发者应遵循以下建议：
- **避免过多规则**: 规则数量直接影响文本处理时间。建议只添加必要的替换规则，避免创建包含数百条规则的庞大词典。
- **合理使用规则**: 优先使用长词匹配规则，避免创建大量短词规则，因为短词可能在长词中被误匹配，导致意料之外的替换。
- **定期审查**: 定期审查 `replace_dict.json` 文件，删除不再需要或无效的规则，保持词典的精简和高效。

**Section sources**
- [serverV2.py](file://serverV2.py#L520-L558)