# 拼接音频

<cite>
**Referenced Files in This Document**   
- [serverV2.py](file://serverV2.py)
- [config.json](file://config.json)
</cite>

## 目录
1. [简介](#简介)
2. [API 端点](#api-端点)
3. [请求模型](#请求模型)
4. [功能说明](#功能说明)
5. [配置说明](#配置说明)
6. [使用示例](#使用示例)
7. [响应](#响应)
8. [性能提示](#性能提示)

## 简介
本文档详细描述了 `/api/splice_audio` API 端点的功能和使用方法。该接口用于将一个小说章节中生成的多个独立音频片段（WAV文件）按顺序拼接成一个完整的连续音频文件，并根据配置导出为指定格式。

**Section sources**
- [serverV2.py](file://serverV2.py#L1864-L1956)

## API 端点
- **URL**: `/api/splice_audio`
- **方法**: `POST`
- **内容类型**: `application/json`

## 请求模型
请求体必须是一个符合 `SpliceRequest` 模型的 JSON 对象。

```json
{
  "novel_name": "string",
  "chapter_name": "string",
  "wav_files": ["string"]
}
```

### 字段说明
- **`novel_name`** (string): 小说项目的名称，用于定位项目目录。
- **`chapter_name`** (string): 章节的名称，用于定位该章节的JSON配置文件和音频文件。
- **`wav_files`** (string[]): 一个包含WAV文件路径的数组。**注意**：根据代码实现，此参数目前被忽略。拼接的顺序和内容由后端根据 `chapter_name` 对应的JSON文件中的内容和音色配置动态生成。

**Section sources**
- [serverV2.py](file://serverV2.py#L80-L81)

## 功能说明
1.  **路径构建**: 接口首先根据 `novel_name` 和 `chapter_name` 构建出项目目录、章节JSON文件和音频输入目录的路径。
2.  **文件验证**: 检查指定的章节JSON文件是否存在，如果不存在则返回404错误。
3.  **数据读取**: 读取 `character_timbres.json` 文件以获取角色音色映射，并读取章节的JSON文件以获取对话内容。
4.  **文件列表生成**: 后端会根据JSON文件中的每一行对话，结合角色和音色信息，**自动生成**需要拼接的WAV文件列表。文件名的生成规则为 `{序号:04d}-{角色名}-{音色名}.wav`。
5.  **音频拼接**: 使用 `pydub` 库按生成的列表顺序加载并拼接WAV文件。
6.  **导出音频**: 拼接完成后，根据 `config.json` 中的 `audio_export` 配置，将最终的音频文件导出到 `output/` 目录下。

**Section sources**
- [serverV2.py](file://serverV2.py#L1864-L1956)

## 配置说明
音频的导出格式和质量由项目根目录下的 `config.json` 文件控制。

```json
{
  "audio_export": {
    "format": "mp3",
    "quality": "256k"
  }
}
```

- **`format`**: 指定导出的音频格式，如 `mp3`, `m4a`, `ogg` 等。
- **`quality`**: 指定导出的音频质量。对于MP3格式，这通常表示比特率，如 `256k`。

**Section sources**
- [config.json](file://config.json#L12-L15)

## 使用示例
尽管 `wav_files` 参数被忽略，但为了保持接口的兼容性，仍需在请求中提供。

### 使用 curl
```bash
curl -X POST http://localhost:8000/api/splice_audio \
  -H "Content-Type: application/json" \
  -d '{
    "novel_name": "我的小说",
    "chapter_name": "第一章_初遇",
    "wav_files": [
      "output/我的小说/wavs/第一章_初遇/0000-张三-温柔男声.wav",
      "output/我的小说/wavs/第一章_初遇/0001-李四-活泼女声.wav"
    ]
  }'
```

### 使用 JavaScript fetch
```javascript
fetch('http://localhost:8000/api/splice_audio', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    novel_name: '我的小说',
    chapter_name: '第一章_初遇',
    wav_files: [
      'output/我的小说/wavs/第一章_初遇/0000-张三-温柔男声.wav',
      'output/我的小说/wavs/第一章_初遇/0001-李四-活泼女声.wav'
    ]
  })
})
.then(response => response.json())
.then(data => console.log(data))
.catch((error) => console.error('Error:', error));
```

**Section sources**
- [serverV2.py](file://serverV2.py#L1864-L1956)

## 响应
### 成功响应
- **状态码**: `200 OK`
- **内容**:
  ```json
  {
    "status": "success",
    "file_path": "/output/我的小说/第一章_初遇.mp3"
  }
  ```
  `file_path` 字段返回最终生成的音频文件的下载路径。

### 错误响应
- **404 Not Found**: 如果指定的章节JSON文件不存在。
- **500 Internal Server Error**: 在拼接或导出过程中发生服务器内部错误。

**Section sources**
- [serverV2.py](file://serverV2.py#L1864-L1956)

## 性能提示
- 拼接过程会将所有音频文件加载到内存中。对于非常长的章节，这可能会导致内存占用过高。建议将过长的章节拆分为多个较短的章节进行处理。

**Section sources**
- [serverV2.py](file://serverV2.py#L1864-L1956)