# 更新全局配置

<cite>
**Referenced Files in This Document**   
- [serverV2.py](file://serverV2.py#L256-L264)
- [config.json](file://config.json)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [核心功能](#核心功能)
3. [API端点详情](#api端点详情)
4. [请求与响应](#请求与响应)
5. [使用示例](#使用示例)
6. [配对操作](#配对操作)
7. [故障排除](#故障排除)

## 简介
本API文档详细说明了`/api/update_llm_config`端点，该端点是AI有声书制作工具的核心配置管理接口。此工具旨在通过AI技术自动化生成高质量的有声书，支持多种文本转语音（TTS）和语言模型（LLM）。`update_llm_config`端点允许用户动态更新全局配置，直接影响所有后续的AI处理任务，如角色分析和语音合成。

**Section sources**
- [README.md](file://README.md#L1-L5)

## 核心功能
`/api/update_llm_config`端点的核心功能是将新的配置对象持久化到服务器的`config.json`文件中。这使得系统管理员或用户能够远程修改关键设置，而无需直接访问服务器文件系统。此操作会立即生效，所有后续的API调用（如文本分析、语音生成）都将基于更新后的配置执行。

**Section sources**
- [serverV2.py](file://serverV2.py#L256-L264)

## API端点详情
- **端点**: `/api/update_llm_config`
- **HTTP方法**: `PUT`
- **功能**: 接收一个包含新配置的JSON对象，并将其写入`config.json`文件。
- **请求体模型**: `LLMConfigRequest`，其结构为 `{"config": { ... }}`，其中 `{ ... }` 是完整的配置对象。

### 可配置项
通过此端点，您可以更新以下配置：
- **LLM模型API密钥**: 在`models`对象下，为`gemini`或`aliyun`等模型设置`api_key`。
- **TTS模型Endpoint**: 在`tts_models`对象下，修改`cosyvoice_v2`或`indextts_v1.5`等模型的`endpoint`地址。
- **代理设置**: 在`general.proxy`对象下，启用/禁用代理（`enabled`），并配置代理的`protocol`、`address`和`port`。
- **默认模型**: 在`general`对象下，更改`default_model`或`default_tts_model`。

**Section sources**
- [serverV2.py](file://serverV2.py#L196-L245)
- [config.json](file://config.json#L1-L45)

## 请求与响应
### 成功响应
- **HTTP状态码**: `200 OK`
- **响应体**: 
  ```json
  {
    "status": "success",
    "message": "模型配置已成功保存。"
  }
  ```

### 失败响应
- **HTTP状态码**: `500 Internal Server Error`
- **响应体**: 
  ```json
  {
    "detail": "写入配置文件失败: [具体的错误信息]"
  }
  ```
  常见的失败原因是服务器上的`config.json`文件权限不足，导致写入操作被拒绝。

**Section sources**
- [serverV2.py](file://serverV2.py#L258-L263)

## 使用示例
以下示例展示了如何使用`curl`命令和JavaScript的`fetch` API来更新配置。

### 使用curl
```bash
curl -X PUT http://localhost:8000/api/update_llm_config \
  -H "Content-Type: application/json" \
  -d '{
    "config": {
      "general": {
        "default_model": "gemini",
        "proxy": {
          "enabled": true,
          "protocol": "socks5h",
          "address": "127.0.0.1",
          "port": "1080"
        },
        "default_tts_model": "cosyvoice_v2"
      },
      "models": {
        "gemini": {
          "api_key": "your_new_gemini_api_key_here"
        }
      }
    }
  }'
```

### 使用JavaScript fetch
```javascript
const newConfig = {
  general: {
    default_model: "gemini",
    proxy: {
      enabled: true,
      protocol: "socks5h",
      address: "127.0.0.1",
      port: "1080"
    },
    default_tts_model: "cosyvoice_v2"
  },
  models: {
    gemini: {
      api_key: "your_new_gemini_api_key_here"
    }
  }
};

fetch('http://localhost:8000/api/update_llm_config', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({ config: newConfig })
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Error:', error));
```

**Section sources**
- [serverV2.py](file://serverV2.py#L256-L264)

## 配对操作
`/api/update_llm_config`端点通常与`/api/get_llm_config`端点配对使用。
- **获取当前配置**: 首先，使用`GET`请求调用`/api/get_llm_config`来获取当前的`config.json`文件内容。这可以作为修改的起点。
- **更新配置**: 修改获取到的配置对象，然后使用`PUT`请求调用`/api/update_llm_config`来保存更改。

**Section sources**
- [serverV2.py](file://serverV2.py#L247-L250)
- [serverV2.py](file://serverV2.py#L256-L264)

## 故障排除
如果调用`/api/update_llm_config`失败并返回500错误，请检查以下几点：
1. **文件权限**: 确保运行`serverV2.py`的用户对`config.json`文件具有写权限。
2. **磁盘空间**: 确认服务器磁盘空间充足。
3. **JSON格式**: 确保请求体中的JSON格式完全正确，任何语法错误都可能导致写入失败。
4. **文件锁定**: 检查`config.json`文件是否被其他进程锁定。

**Section sources**
- [serverV2.py](file://serverV2.py#L262-L263)