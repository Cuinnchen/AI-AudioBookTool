# 生成语音

<cite>
**本文档引用的文件**   
- [serverV2.py](file://serverV2.py)
- [config.json](file://config.json)
</cite>

## 目录
1. [简介](#简介)
2. [API端点: `/api/tts_v2`](#api端点-apitts_v2)
3. [请求模型 `TTSRequestV2`](#请求模型-ttsrequestv2)
4. [功能详解](#功能详解)
5. [使用示例](#使用示例)
6. [返回值与错误码](#返回值与错误码)
7. [配置依赖](#配置依赖)

## 简介
本文档详细说明了`AI-AudioBookTool`项目中用于生成语音的核心API端点`/api/tts_v2`。该接口负责接收文本和音色配置，调用后端TTS微服务生成WAV音频文件，并将其保存至指定目录。它是整个有声书生成流程中的关键环节。

## API端点 `/api/tts_v2`

该API端点用于触发单句文本到语音的转换过程。

- **路径**: `/api/tts_v2`
- **方法**: `POST`
- **内容类型**: `application/json`

**Section sources**
- [serverV2.py](file://serverV2.py#L1728-L1861)

## 请求模型 `TTSRequestV2`

该API接收一个名为`TTSRequestV2`的JSON对象作为请求体，其结构定义如下：

| 字段名 | 类型 | 是否必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `novel_name` | `string` | 是 | 小说项目的名称，用于确定输出文件的保存路径。 |
| `chapter_name` | `string` | 是 | 章节的名称，用于在`output/wavs/`下创建对应的子目录。 |
| `row_index` | `integer` | 是 | 当前文本在章节中的行索引，用于生成唯一且有序的文件名。 |
| `speaker` | `string` | 是 | 说话者的角色名称，用于生成文件名。 |
| `timbre` | `string` | 是 | 说话者使用的音色名称，用于生成文件名。 |
| `tts_text` | `string` | 是 | 需要转换为语音的原始文本内容。 |
| `prompt_audio` | `string` | 是 | 用于零样本语音克隆的参考音频（Base64编码）。 |
| `prompt_text` | `string` | 是 | 与`prompt_audio`对应的参考文本，用于指导TTS模型。 |
| `inference_mode` | `string` | 是 | 控制TTS生成模式的字符串，如`"sft"`（标准生成）、`"zero_shot"`（零样本克隆）等。 |
| `instruct_text` | `string` | 否 | 指令文本，可为TTS模型提供额外的生成指导。 |
| `tts_model` | `string` | 否 | 指定要使用的TTS模型ID（如`"cosyvoice_v2"`），若不指定则使用`config.json`中的默认值。 |

**Section sources**
- [serverV2.py](file://serverV2.py#L75-L79)

## 功能详解

`/api/tts_v2`端点的核心功能是根据请求中的参数生成高质量的语音文件。其工作流程如下：

1.  **加载配置**: 从`config.json`文件中读取TTS模型的配置信息。
2.  **确定TTS模型**: 根据请求中的`ttts_model`字段或`config.json`中的`default_tts_model`设置，确定要调用的TTS微服务。
3.  **应用文本替换**: 调用`apply_replacement_rules`函数，根据小说专属的替换词典对`tts_text`进行预处理，以修正特定词汇的发音。
4.  **构建请求负载**: 将处理后的文本、参考音频、参考文本、推理模式等信息打包成一个完整的JSON payload。
5.  **调用TTS微服务**: 使用`requests.post`向配置的TTS微服务`endpoint`（例如`http://127.0.0.1:5010/api/tts`）发送请求。
6.  **重试与质量检查**: 内置一个最大5次的重试循环。每次生成后，会分析音频结尾的能量（dBFS）。如果能量过高，可能意味着音频被截断，系统会自动重试，并选择“最不戛然而止”的音频作为最佳结果。
7.  **保存音频文件**: 将生成的最佳音频数据（Base64解码后）保存到`output/{novel_name}/wavs/{chapter_name}/`目录下，文件名格式为`{行索引}-{说话者}-{音色}.wav`。

**Section sources**
- [serverV2.py](file://serverV2.py#L1728-L1861)
- [serverV2.py](file://serverV2.py#L520-L558)
- [config.json](file://config.json#L16-L25)

## 使用示例

### 使用 curl 命令

```bash
curl -X POST http://localhost:8000/api/tts_v2 \
  -H "Content-Type: application/json" \
  -d '{
    "novel_name": "红楼梦",
    "chapter_name": "第一回",
    "row_index": 1,
    "speaker": "贾宝玉",
    "timbre": "青年男声",
    "tts_text": "这女儿两个字，极尊贵，极清净的。",
    "prompt_audio": "base64_encoded_audio_data_here",
    "prompt_text": "这女儿两个字，极尊贵，极清净的。",
    "inference_mode": "zero_shot"
  }'
```

### 使用 JavaScript fetch

```javascript
const requestData = {
  novel_name: "红楼梦",
  chapter_name: "第一回",
  row_index: 1,
  speaker: "贾宝玉",
  timbre: "青年男声",
  tts_text: "这女儿两个字，极尊贵，极清净的。",
  prompt_audio: "base64_encoded_audio_data_here",
  prompt_text: "这女儿两个字，极尊贵，极清净的。",
  inference_mode: "zero_shot"
};

fetch('http://localhost:8000/api/tts_v2', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(requestData)
})
.then(response => response.json())
.then(data => {
  console.log('Success:', data);
  // data.file_name 包含了生成的音频文件名
})
.catch((error) => {
  console.error('Error:', error);
});
```

## 返回值与错误码

### 成功响应
- **状态码**: `200 OK`
- **响应体**: 一个JSON对象。
    ```json
    {
      "status": "success",
      "file_name": "0001-贾宝玉-青年男声.wav"
    }
    ```
    `file_name`字段返回了在`output/wavs/`目录下生成的音频文件的文件名。

### 错误响应

| 状态码 | 原因 | 响应示例 |
| :--- | :--- | :--- |
| `400 Bad Request` | 请求参数缺失或无效，例如未找到有效的TTS模型配置。 | `{"detail": "未找到有效的目标 TTS 模型配置。"}` |
| `500 Internal Server Error` | 服务器内部错误，例如TTS微服务调用失败、生成音频失败或服务器处理过程中发生异常。 | `{"detail": "TTS生成失败，未能获取到任何音频数据。"}` |
| `503 Service Unavailable` | 无法连接到下游的TTS微服务。 | `{"detail": "无法连接到 TTS 服务: ..."} ` |

**Section sources**
- [serverV2.py](file://serverV2.py#L1728-L1861)

## 配置依赖

`/api/tts_v2`端点的功能高度依赖于`config.json`文件中的配置，特别是`"tts_models"`和`"general"`部分：

- **`tts_models`**: 定义了可用的TTS模型及其对应的微服务`endpoint`。例如，`"cosyvoice_v2"`模型的`endpoint`被设置为`"http://127.0.0.1:5010/api/tts"`。
- **`default_tts_model`**: 指定了当请求中未明确指定`ttts_model`时，默认使用的TTS模型。

**Section sources**
- [config.json](file://config.json#L16-L25)
- [config.json](file://config.json#L10-L11)