# 打包下载章节音频

<cite>
**Referenced Files in This Document**   
- [serverV2.py](file://serverV2.py)
- [index.html](file://index.html)
</cite>

## 目录
1. [简介](#简介)
2. [API端点说明](#api端点说明)
3. [处理流程](#处理流程)
4. [使用示例](#使用示例)
5. [错误处理](#错误处理)

## 简介
本API文档详细描述了`/api/download_spliced_chapters`端点的功能和使用方法。该接口用于将指定小说所有已拼接完成的章节音频文件打包成ZIP压缩包，并通过流式响应返回给前端进行下载。

## API端点说明
- **端点**: `/api/download_spliced_chapters`
- **方法**: POST
- **功能**: 接收一个包含音频文件路径的列表，将这些文件打包成ZIP压缩包，并通过流式响应返回。
- **参数**: 
  - `file_paths`: 字符串数组，包含要下载的音频文件路径。

**Section sources**
- [serverV2.py](file://serverV2.py#L2350-L2410)

## 处理流程
1. **接收请求**: 接收包含`file_paths`的POST请求。
2. **验证路径**: 检查每个文件路径是否在合法的输出目录内，防止目录遍历攻击。
3. **检查文件存在性**: 验证每个文件路径对应的文件是否存在。
4. **创建ZIP包**: 使用`zipfile`库在内存中创建ZIP包，并将所有有效的文件添加到ZIP包中。
5. **生成文件名**: 根据第一个文件路径的目录名生成ZIP文件名，格式为`{novel_name}_spliced.zip`。
6. **处理中文文件名**: 如果文件名包含非ASCII字符，使用RFC 6266标准处理，确保浏览器能正确下载。
7. **返回流式响应**: 使用`StreamingResponse`将ZIP包作为流式响应返回，节省内存。

**Section sources**
- [serverV2.py](file://serverV2.py#L2350-L2410)

## 使用示例
### curl命令示例
```bash
curl -G --data-urlencode "novel_name=小说名" http://localhost:8000/api/download_spliced_chapters -o audio.zip
```

### JavaScript fetch调用示例
```javascript
try {
    const response = await fetch('/api/download_spliced_chapters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ file_paths: filePathsToDownload })
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || '打包失败。');
    }

    const blob = await response.blob();
    const contentDisposition = response.headers.get('content-disposition');
    let filename = 'chapters.zip';
    if (contentDisposition) {
        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
        if (filenameMatch.length > 1) {
            filename = filenameMatch[1];
        }
    }

    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
    setStatus('文件打包下载成功！', 'success');
} catch (error) {
    setStatus(`下载失败: ${error.message}`, 'error');
}
```

**Section sources**
- [serverV2.py](file://serverV2.py#L2350-L2410)
- [index.html](file://index.html#L3444-L3509)

## 错误处理
- **400错误**: 如果请求中没有提供`file_paths`，返回400错误，提示“没有提供需要下载的文件路径。”
- **404错误**: 如果所有请求的文件都不存在或不合法，返回404错误，提示“所有请求的文件都不存在或不合法。”

**Section sources**
- [serverV2.py](file://serverV2.py#L2350-L2410)