# 角色分析与简介生成

<cite>
**本文档引用的文件**   
- [serverV2.py](file://serverV2.py#L594-L678)
- [config.json](file://config.json)
- [serverV2.py](file://serverV2.py#L1081-L1229)
- [serverV2.py](file://serverV2.py#L767-L813)
</cite>

## 目录
1. [函数实现机制](#函数实现机制)
2. [请求构建逻辑](#请求构建逻辑)
3. [响应解析与容错](#响应解析与容错)
4. [数据持久化与前端触发](#数据持久化与前端触发)
5. [错误处理](#错误处理)

## 函数实现机制

`analyze_character`函数是角色分析与简介生成的核心。该函数接收角色名、上下文文本和指定的LLM模型名称作为参数。首先，函数从`config.json`文件中读取指定模型（Gemini或阿里云）的配置信息，包括API密钥、模型名称和代理设置。接着，函数构造一个包含角色名和上下文文本的分析提示词（analysis_prompt），该提示词严格要求AI返回一个包含`gender`、`ageGroup`和`identity`三个键的JSON对象。最后，函数调用外部大模型API，生成角色简介。

**Section sources**
- [serverV2.py](file://serverV2.py#L594-L678)

## 请求构建逻辑

函数内部的请求构建逻辑根据不同的模型平台（Gemini与阿里云）进行差异化处理。对于Gemini模型，API端点为`https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent`，请求头包含`Content-Type`和`x-goog-api-key`，Payload格式为包含文本提示的JSON对象。对于阿里云模型，API端点为`https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation`，请求头包含`Authorization`和`Content-Type`，Payload格式为包含系统消息和用户消息的JSON对象。函数通过条件判断选择相应的API端点、请求头和Payload格式，确保请求的正确性。

**Section sources**
- [serverV2.py](file://serverV2.py#L594-L678)

## 响应解析与容错

函数从AI返回的响应文本中提取并解析JSON对象。首先，函数根据模型平台从响应数据中提取文本内容。然后，函数使用正则表达式在文本中查找JSON对象，并尝试解析。如果解析成功且包含必需的键，则返回解析后的JSON对象。如果解析失败，函数会记录警告信息并返回`None`。这种容错策略确保了在AI返回格式不正确的响应时，函数不会崩溃，而是优雅地处理错误。

**Section sources**
- [serverV2.py](file://serverV2.py#L594-L678)

## 数据持久化与前端触发

生成的简介被持久化存储到`projects/{novel_name}/character_profiles.json`文件中。当处理单个章节时，如果发现新角色，函数会调用`analyze_character`生成简介，并将其添加到角色简介文件中。前端通过`/api/analyze_character`端点触发此流程。用户在前端界面选择角色和模型后，前端发送请求到该端点，后端执行角色分析并返回结果。

**Section sources**
- [serverV2.py](file://serverV2.py#L1081-L1229)
- [serverV2.py](file://serverV2.py#L767-L813)

## 错误处理

函数在处理过程中会遇到多种错误，如API密钥缺失、网络超时等。对于API密钥缺失，函数会在读取配置文件后检查密钥是否存在，如果不存在则记录错误并返回`None`。对于网络超时，函数在发送请求时设置了120秒的超时时间，并在捕获到异常时记录错误信息。此外，函数还处理了JSON解析错误、文件读取错误等，确保在各种异常情况下都能提供有意义的错误信息。

**Section sources**
- [serverV2.py](file://serverV2.py#L594-L678)