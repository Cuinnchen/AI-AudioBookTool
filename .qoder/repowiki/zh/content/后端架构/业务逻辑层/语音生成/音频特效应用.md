# 音频特效应用

<cite>
**本文档中引用的文件**   
- [serverV2.py](file://serverV2.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [API端点实现](#api端点实现)
4. [音频特效技术实现](#音频特效技术实现)
5. [处理流程与结果返回](#处理流程与结果返回)

## 简介
本文档详细说明了`/api/apply_effect` API端点如何实现三种音频特效：手机通话、喇叭喊话和室内回声。文档解析了`apply_audio_effect`函数的实现逻辑，包括如何通过`EffectRequest`模型接收请求参数（novel_name, chapter_name, file_name, effect_type），并阐述了每种特效的技术实现细节。

## 核心组件

**Section sources**
- [serverV2.py](file://serverV2.py#L99-L103)

## API端点实现

**Section sources**
- [serverV2.py](file://serverV2.py#L1376-L1384)

## 音频特效技术实现

### 手机通话效果
手机通话效果通过以下步骤实现：
1. 使用高通滤波器（300Hz）和低通滤波器（3400Hz）限制音频频率范围，模拟电话语音的频带。
2. 轻微增加音量（+3dB），模拟压缩效果。
3. 将音频采样率降低至8000Hz，这是电话语音的标准采样率，以产生“lo-fi”数码感。
4. 再将采样率恢复至原始值，通过重采样过程进一步增强数码感。

### 喇叭喊话效果
喇叭喊话效果通过以下步骤实现：
1. 使用高通滤波器（500Hz）和低通滤波器（5000Hz）限制频率范围。
2. 应用立体声增益（+6dB）和动态范围压缩（threshold=-10.0），通过轻微过载增加失真感，模拟喇叭的失真效果。

### 室内回声效果
室内回声效果通过以下步骤实现：
1. 创建两个原始音频的副本，并分别降低18dB和24dB的音量。
2. 将这两个衰减后的副本分别延迟150ms和300ms。
3. 使用`overlay`方法将延迟后的副本与原始音频叠加，从而实现室内回声效果。

**Section sources**
- [serverV2.py](file://serverV2.py#L1386-L1417)

## 处理流程与结果返回

### 音频处理与标准化
处理后的音频在导出前会通过`normalize`函数进行标准化，以防止削波（clipping），确保音频质量。标准化后的音频将覆盖保存原始文件。

### 成功消息返回
处理成功后，函数返回一个包含具体特效名称的成功消息。通过`effect_name_map`字典将内部的`effect_type`值映射为中文名称：
- `phone` 映射为 "手机通话"
- `megaphone` 映射为 "喇叭喊话"
- `reverb` 映射为 "室内回声"

最终返回的JSON响应包含状态和消息，例如：`{"status": "success", "message": "'手机通话' 特效已应用。"}`。

**Section sources**
- [serverV2.py](file://serverV2.py#L1421-L1427)