# 音频处理

<cite>
**Referenced Files in This Document**   
- [serverV2.py](file://serverV2.py)
- [config.json](file://config.json)
</cite>

## 目录
1. [音频拼接技术](#音频拼接技术)
2. [音频特效处理](#音频特效处理)
3. [音频导出与打包](#音频导出与打包)

## 音频拼接技术

`splice_audio`函数是音频后期处理的核心，负责将单个章节内生成的多个WAV片段按顺序拼接成完整的章节音频。该函数通过读取章节的JSON配置文件，根据其中的`speaker`和`timbre`信息，构建出需要拼接的WAV文件列表，确保了与前端逻辑的一致性。

在拼接过程中，函数会遍历构建的文件列表，使用`pydub.AudioSegment.from_wav()`方法加载每个WAV文件，并通过`+=`操作符将它们顺序连接到一个空的`AudioSegment`对象中。此过程会自动处理音频的采样率和声道，实现无缝拼接。

**Section sources**
- [serverV2.py](file://serverV2.py#L1864-L1956)

## 音频特效处理

系统通过`/api/apply_effect`端点实现手机通话、喇叭喊话等音频特效。该功能利用`pydub.effects`和`pydub.scipy_effects`模块进行音频信号处理。

对于“手机通话”特效，系统应用了低通和高通滤波器，将音频频率限制在300Hz至3400Hz之间，模拟电话的窄带语音。此外，通过将音频采样率降至8000Hz再恢复，产生独特的“lo-fi”数码感。

对于“喇叭喊话”特效，系统同样应用了滤波器（500Hz-5000Hz），并增加了轻微的增益和动态范围压缩，以模拟喇叭的失真效果。

所有处理后的音频在导出前都会应用`normalize`函数进行音量归一化，确保输出音量一致，防止削波。

**Section sources**
- [serverV2.py](file://serverV2.py#L1376-L1449)

## 音频导出与打包

### 音频导出
音频的最终导出格式由`config.json`文件中的`audio_export`配置决定。`splice_audio`函数在拼接完成后，会读取该配置，支持导出为MP3、M4A或OGG格式。例如，当配置为MP3时，会使用`bitrate`参数指定码率（如256k），并通过`combined.export()`方法完成导出。

### 打包下载
`/api/download_spliced_chapters`端点负责将所有已拼接的章节音频打包成ZIP文件供用户下载。该功能使用Python的`zipfile`模块在内存中创建ZIP包，将指定的音频文件写入其中。为了正确处理包含中文的文件名，系统实现了RFC 6266标准的`Content-Disposition`响应头，确保下载的ZIP文件名在各种浏览器中都能正确显示。

**Section sources**
- [serverV2.py](file://serverV2.py#L2350-L2411)
- [config.json](file://config.json#L12-L15)