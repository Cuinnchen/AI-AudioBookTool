# 应用数据结构

<cite>
**本文档引用的文件**   
- [config.json](file://config.json)
- [serverV2.py](file://serverV2.py)
- [character_timbres.json](file://character_timbres.json)
- [replace_dict.json](file://replace_dict.json)
</cite>

## 目录
1. [系统配置文件 (config.json)](#系统配置文件-configjson)
2. [角色音色映射文件 (character_timbres.json)](#角色音色映射文件-charactertimbresjson)
3. [文本替换规则文件 (replace_dict.json)](#文本替换规则文件-replacedictjson)
4. [章节数据结构与生成流程](#章节数据结构与生成流程)

## 系统配置文件 (config.json)

`config.json` 是应用的核心配置文件，定义了全局运行参数、模型设置、TTS服务端点以及音频导出选项。其结构清晰，分为多个顶级字段。

### general 字段
`general` 字段定义了应用的全局默认设置和代理配置。
- **default_model**: 指定用于文本处理的默认大语言模型（LLM），例如 `"gemini"`。
- **proxy**: 包含一个嵌套对象，用于配置网络代理。
  - **enabled**: 布尔值，控制代理是否启用。
  - **protocol**: 代理协议，如 `"socks5h"`。
  - **address**: 代理服务器地址，如 `"127.0.0.1"`。
  - **port**: 代理服务器端口，如 `"1080"`。
- **default_tts_model**: 指定用于语音合成的默认TTS模型，例如 `"cosyvoice_v2"`。

### audio_export 字段
`audio_export` 字段定义了最终拼接音频的导出格式和质量。
- **format**: 导出的音频文件格式，例如 `"mp3"`。
- **quality**: 音频质量，例如 `"256k"`，表示比特率为256kbps。

### tts_models 字段
`tts_models` 字段是一个对象，其键为TTS模型的ID，值为包含该模型详细信息的对象。
- **模型ID (如 "cosyvoice_v2")**: 每个模型ID对应一个配置对象。
  - **display_name**: 在用户界面中显示的名称，例如 `"CosyVoice2"`。
  - **endpoint**: 该TTS模型微服务的API端点URL，例如 `"http://127.0.0.1:5010/api/tts"`。应用通过此端点与TTS服务通信。

### models 字段
`models` 字段是一个对象，其键为LLM的ID，值为包含该模型详细信息的对象。
- **模型ID (如 "gemini")**: 每个模型ID对应一个配置对象。
  - **display_name**: 在用户界面中显示的名称，例如 `"Gemini"`。
  - **model_name**: LLM服务中实际的模型名称，例如 `"gemini-2.5-flash"`。
  - **api_key**: 访问该LLM服务所需的API密钥，初始为空字符串。
  - **max_chars**: 单次请求发送给LLM的最大字符数，用于处理长文本时的分块。
  - **use_proxy**: 布尔值，指示调用此模型时是否使用 `general` 字段中配置的代理。

### elevenlabs 字段
`elevenlabs` 字段包含一个API密钥，用于配置与ElevenLabs语音识别（STT）服务的集成。
- **api_key**: 访问ElevenLabs API的密钥，初始为空字符串。

**Section sources**
- [config.json](file://config.json#L1-L45)
- [serverV2.py](file://serverV2.py#L195-L245)

## 角色音色映射文件 (character_timbres.json)

`character_timbres.json` 文件在音色管理中扮演着核心角色，它存储了特定小说项目中角色与音色之间的映射关系。

### 结构与作用
该文件是一个简单的JSON对象，其结构为 **键值对 (key-value pairs)**。
- **键 (Key)**: 小说中的**角色名**（例如 `"张三丰"`）。
- **值 (Value)**: 分配给该角色的**音色名**（例如 `"老者音"`）。

这种结构实现了角色与音色的一对一绑定。当应用需要为某个角色生成语音时，它会查询此文件，根据角色名找到对应的音色名，然后使用该音色的参考音频和文本（通常存储在 `wav/音色名/` 目录下）来驱动TTS模型，从而确保同一角色的语音风格在整个有声书中保持一致。

**Section sources**
- [serverV2.py](file://serverV2.py#L386-L390)
- [serverV2.py](file://serverV2.py#L1886-L1890)

## 文本替换规则文件 (replace_dict.json)

`replace_dict.json` 文件定义了在TTS生成前应用于文本的替换规则，用于解决特定词汇的发音问题或进行文本规范化。

### 结构与逻辑
该文件的结构是一个包含 `rules` 数组的JSON对象。
```json
{
  "rules": [
    {
      "original_word": "原词",
      "replacement_word": "替换词",
      "description": "可选的描述"
    },
    ...
  ]
}
```
- **rules**: 一个包含多个替换规则对象的数组。
  - **original_word**: 需要被替换的原始文本。
  - **replacement_word**: 用于替换原始文本的新文本。
  - **description**: 对该规则的可选说明。

**文本替换逻辑**:
1.  **加载**: 当处理某个小说的章节时，应用会加载该小说项目下的 `replace_dict.json` 文件。
2.  **排序**: 为了防止短词替换影响长词（例如，先替换“行长”而不是“行”），所有规则会按照 `original_word` 的长度从长到短进行排序。
3.  **应用**: 应用会遍历排序后的规则列表，使用正则表达式对TTS文本进行逐条替换。
4.  **生成**: 经过所有替换规则处理后的文本才会被发送给TTS服务进行语音合成。

**Section sources**
- [serverV2.py](file://serverV2.py#L521-L558)
- [serverV2.py](file://serverV2.py#L1959-L2007)

## 章节数据结构与生成流程

### 章节JSON数据结构
有声书的每个章节都由一个JSON数组表示，数组中的每个元素是一个对象，代表一句旁白或角色对话。其核心结构为 `[{speaker, content, tone, intensity, delay}]`。
- **speaker**: 说话者姓名。对于旁白，固定为 `"旁白"`；对于角色对话，则为具体的角色名。
- **content**: 对话或旁白的实际文本内容。
- **tone**: 对语气的描述，如 `"正常"`、`"愤怒"`、`"开心"` 等，用于指导TTS的情感表达。
- **intensity**: 语气强度，一个1到10之间的整数，数值越大表示情感越强烈。
- **delay**: 与上一句话之间的停顿时间，以毫秒为单位，用于控制语句间的节奏。

### 生成流程与PROMPT_TEMPLATE
该JSON结构由大语言模型（LLM）根据 `serverV2.py` 中定义的 `PROMPT_TEMPLATE` 提示词生成。

`PROMPT_TEMPLATE` 是一个精心设计的指令，它严格规定了LLM的输出格式和内容要求：
1.  **格式要求**: 输出必须是一个有效的JSON数组。
2.  **字段要求**: 明确要求每个对象必须包含 `speaker`, `content`, `tone`, `intensity`, `delay` 这五个字段。
3.  **内容规则**: 详细说明了旁白和角色对话的处理方式，包括如何拆分长段落、如何处理引号、如何保持原文顺序等。
4.  **特殊要求**: 强调不能添加额外字段，必须保持语义完整性。

当用户上传小说文本后，应用会将文本与 `PROMPT_TEMPLATE` 拼接，发送给配置的LLM（如Gemini或阿里云）。LLM会严格按照提示词的要求，将小说文本分析并转换为符合规范的JSON数组，从而确保了生成数据的格式一致性。

### 数据示例与生命周期
- **数据示例**:
```json
[
  {
    "speaker": "旁白",
    "content": "这是一个宁静的夜晚。",
    "tone": "正常",
    "intensity": 5,
    "delay": 500
  },
  {
    "speaker": "张三丰",
    "content": "徒儿，你来了。",
    "tone": "慈祥",
    "intensity": 6,
    "delay": 300
  }
]
```
- **存储路径**: 生成的章节JSON文件存储在 `projects/小说名/chapters_json/` 目录下，文件名为 `安全化后的章节标题.json`。
- **生命周期管理**: 该文件是TTS生成和音频拼接的核心输入。当用户选择“强制重新生成”时，旧的JSON文件会被删除，然后重新调用LLM生成新的JSON数据，从而触发整个音频生成流程的更新。

**Section sources**
- [serverV2.py](file://serverV2.py#L153-L185)
- [serverV2.py](file://serverV2.py#L561-L592)