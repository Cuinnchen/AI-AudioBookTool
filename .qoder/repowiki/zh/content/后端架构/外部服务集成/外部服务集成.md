# 外部服务集成

<cite>
**本文档引用的文件**   
- [serverV2.py](file://serverV2.py)
- [config.json](file://config.json)
</cite>

## 目录
1. [LLM服务集成](#llm服务集成)
2. [TTS服务集成](#tts服务集成)
3. [STT服务集成](#stt服务集成)
4. [配置管理](#配置管理)

## LLM服务集成

系统通过 `generate_with_gemini` 和 `generate_with_qwen` 两个核心函数分别集成 Google Gemini 和阿里云通义千问（Qwen）的大型语言模型（LLM）服务，用于将小说文本分析并转换为结构化的有声书JSON格式。

### Google Gemini 集成
`generate_with_gemini` 函数负责调用 Google Gemini API。其工作流程如下：
1.  **请求构造**：函数接收章节内容、模型ID、API密钥等参数。它使用预定义的 `PROMPT_TEMPLATE` 模板，将用户提供的文本内容拼接成符合要求的提示词（prompt），并构建符合 Gemini API 规范的JSON请求体。该请求体明确指定了 `response_mime_type` 为 `application/json`，以确保返回格式化JSON。
2.  **认证方式**：采用API密钥进行认证。密钥通过HTTP请求头中的 `x-goog-api-key` 字段传递。
3.  **代理支持**：函数支持通过代理服务器访问API。代理配置从 `config.json` 文件中读取，当 `models.gemini.use_proxy` 设置为 `true` 时，会根据 `general.proxy` 的配置（协议、地址、端口）构建代理字典，并在 `requests.post` 调用中传入。
4.  **安全设置**：在请求中，通过 `SAFETY_SETTINGS` 参数明确设置了所有安全类别（如骚扰、仇恨言论等）的阈值为 `BLOCK_NONE`，确保模型不会因内容安全策略而拒绝生成内容。
5.  **响应解析与错误处理**：函数会解析API返回的JSON响应，提取 `candidates[0].content.parts[0].text` 中的文本内容。它会验证返回的文本是否为有效的JSON数组。如果模型生成被截断（`finishReason` 不为 "STOP"），则视为错误。该函数实现了重试机制，在失败时会进行最多 `MAX_RETRIES` 次重试。

### 阿里云通义千问 集成
`generate_with_qwen` 函数负责调用阿里云通义千问API。其工作流程与Gemini类似，但遵循阿里云API的规范：
1.  **请求构造**：同样使用 `PROMPT_TEMPLATE` 构造提示词。请求体采用阿里云要求的格式，将提示词作为用户消息（`role: "user"`）发送，并在 `parameters` 中指定 `result_format` 为 `message`。
2.  **认证方式**：采用Bearer Token进行认证。API密钥通过HTTP请求头中的 `Authorization` 字段，以 `Bearer {api_key}` 的格式传递。
3.  **代理支持**：与Gemini集成相同，支持通过 `config.json` 中的代理配置进行代理访问。
4.  **响应解析与错误处理**：函数从 `output.choices[0].message.content` 中提取返回的文本。特别地，它会处理API可能返回的Markdown代码块（```json ... ```），并尝试从中提取纯JSON字符串。随后进行JSON格式验证。该函数同样实现了重试机制。

**Section sources**
- [serverV2.py](file://serverV2.py#L264-L355)
- [config.json](file://config.json#L26-L40)

## TTS服务集成

系统通过 `tts_v2` 函数实现与多个TTS微服务的动态集成。该函数根据配置，灵活选择并调用不同的TTS后端。

### 动态模型选择
`tts_v2` 函数首先从 `config.json` 文件中读取 `tts_models` 配置。它根据请求中指定的 `tts_model` 参数或 `general.default_tts_model` 的默认值，从配置中查找对应的模型ID。每个模型ID都关联一个 `display_name` 和一个 `endpoint`（服务地址）。

### 调用流程
1.  **配置加载与模型选择**：函数加载全局配置，确定要使用的TTS模型及其API端点。
2.  **文本预处理**：在发送请求前，会调用 `apply_replacement_rules` 函数，根据小说专属的替换词典对文本进行预处理。
3.  **请求构造**：构建一个包含以下关键字段的JSON payload：
    *   `tts_text`: 经过替换规则处理后的待合成文本。
    *   `prompt_audio`: 参考音频的Base64编码字符串。
    *   `prompt_text`: 参考文本。
    *   `inference_mode`: 推理模式（如zero_shot）。
    *   `instruct_text`: 指令文本（可选）。
4.  **异步HTTP请求与重试**：函数使用 `requests.post` 向选定的TTS微服务端点发送请求。它实现了强大的内部重试机制（`TTS_GENERATION_MAX_RETRIES` 次）。在每次重试后，它会分析生成音频的结尾能量（`dBFS`）。如果结尾能量过高，可能意味着音频被截断，系统会记录此情况并尝试重新生成。最终，它会选择“最不戛然而止”的音频作为最佳结果进行保存。
5.  **音频保存**：成功获取音频数据（Base64解码后）后，会将其保存到指定的输出目录，文件名包含行索引、说话者和音色信息。

**Section sources**
- [serverV2.py](file://serverV2.py#L1728-L1867)
- [config.json](file://config.json#L16-L24)

## STT服务集成

系统通过 `stt_elevenlabs` 函数集成ElevenLabs的语音识别（STT）服务。

### 集成流程
1.  **认证方式**：函数从 `config.json` 文件的 `elevenlabs.api_key` 字段读取API密钥。该密钥通过HTTP请求头中的 `xi-api-key` 字段传递。
2.  **API端点**：使用 `https://api.elevenlabs.io/v1/speech-to-text` 作为API端点。
3.  **请求构造**：请求采用 `multipart/form-data` 格式。它包含一个名为 `file` 的文件字段，上传用户提交的音频文件，以及一个名为 `model_id` 的数据字段，指定使用 `scribe_v1` 模型。
4.  **响应解析与错误处理**：函数解析API返回的JSON响应，提取 `text` 字段中的识别结果。它实现了完善的错误处理机制，能够捕获网络请求异常，并尝试解析ElevenLabs返回的详细错误信息（如 `detail` 字段），特别是对401 Unauthorized错误进行特殊处理，以提供更清晰的错误提示。

**Section sources**
- [serverV2.py](file://serverV2.py#L2413-L2491)

## 配置管理

所有外部服务的配置均集中管理于 `config.json` 文件中，便于维护和修改。

### 配置项说明
*   **LLM模型 (`models`)**:
    *   `gemini`: 包含 `api_key` (API密钥), `model_name` (模型ID), `max_chars` (单次请求最大字符数), `use_proxy` (是否使用代理)。
    *   `aliyun`: 包含 `api_key`, `model_name`, `max_chars`, `use_proxy`。
*   **TTS模型 (`tts_models`)**:
    *   每个模型（如 `cosyvoice_v2`, `indextts_v1.5`）包含 `display_name` (显示名称) 和 `endpoint` (API服务地址)。
*   **通用设置 (`general`)**:
    *   `default_model`: 默认使用的LLM模型。
    *   `default_tts_model`: 默认使用的TTS模型。
    *   `proxy`: 代理服务器的全局配置（启用、协议、地址、端口）。
*   **STT服务 (`elevenlabs`)**:
    *   `api_key`: ElevenLabs服务的API密钥。

用户可以通过前端界面或直接编辑 `config.json` 文件来更新这些配置，系统在启动时会自动加载这些设置。

**Section sources**
- [config.json](file://config.json#L1-L45)
- [serverV2.py](file://serverV2.py#L195-L245)