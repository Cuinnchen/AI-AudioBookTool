# 技术栈与依赖

<cite>
**本文档引用的文件**
- [serverV2.py](file://serverV2.py)
- [config.json](file://config.json)
- [index.html](file://index.html)
- [style.css](file://style.css)
- [启动ServerV2.bat](file://启动ServerV2.bat)
</cite>

## 目录
1. [后端技术栈](#后端技术栈)
2. [前端技术栈](#前端技术栈)
3. [外部服务集成](#外部服务集成)
4. [依赖库作用与调用位置](#依赖库作用与调用位置)
5. [依赖安装与运行](#依赖安装与运行)
6. [配置文件说明](#配置文件说明)

## 后端技术栈

本项目后端采用Python生态构建，核心框架为**FastAPI**，用于创建高性能的RESTful API。FastAPI利用Python的类型提示和Pydantic模型，提供了自动生成的API文档（如Swagger UI）和数据验证功能，极大地提升了开发效率和接口的健壮性。项目入口文件为`serverV2.py`，其中通过`import fastapi`语句引入框架，并创建`app = FastAPI(...)`实例来定义和挂载所有API路由。

数据验证与模型定义由**Pydantic**库完成。在`serverV2.py`文件中，通过`from pydantic import BaseModel`导入，并定义了一系列继承自`BaseModel`的类（如`TTSRequestV2`, `SpliceRequest`等），这些类用于严格校验API请求体中的数据结构和类型，确保了前后端数据交互的准确性。

**requests**库是项目与外部AI服务进行HTTP通信的核心。它被用于调用LLM（大语言模型）服务（如Gemini、阿里云）、TTS（文本转语音）服务和STT（语音转文本）服务。在`serverV2.py`中，`import requests`后，代码通过`requests.post()`等方法向外部API端点发送请求，并处理返回的JSON响应。

音频处理方面，项目使用了**pydub**和**soundfile**两个库。`pydub`（通过`from pydub import AudioSegment`导入）负责高级音频操作，如音频的加载、拼接（`+`操作符）、效果处理（如标准化`normalize`、高低通滤波`low_pass_filter`/`high_pass_filter`）和导出。`soundfile`（通过`import soundfile as sf`导入）则用于底层的音频文件读写，确保了与不同音频格式的兼容性。

**Section sources**
- [serverV2.py](file://serverV2.py#L1-L48)
- [serverV2.py](file://serverV2.py#L57-L149)

## 前端技术栈

本项目前端采用原生HTML、CSS和JavaScript实现，无任何额外框架（如React、Vue）依赖，保证了轻量化和高执行效率。用户界面由`index.html`文件定义，其结构为一个四列布局的工作台，分别用于小说管理、角色配置、音色库和内容编辑。

样式由`style.css`文件提供，使用了CSS变量（`:root`）来统一管理颜色、字体和间距等设计令牌，确保了视觉风格的一致性。CSS Grid和Flexbox布局被用于构建响应式和自适应的界面。

前端通过JavaScript的**fetch API**与后端进行动态交互。所有与后端的通信，如获取小说列表、处理文本、生成语音、保存配置等，都是通过`fetch()`函数发起的异步HTTP请求完成的。例如，在`index.html`中，`fetchFromServer()`函数封装了`fetch`调用，用于向`/api/`下的各个端点发送请求，并处理返回的JSON数据以更新UI。

**Section sources**
- [index.html](file://index.html#L1-L800)
- [style.css](file://style.css#L1-L190)

## 外部服务集成

本项目集成了多个外部AI服务，其配置和调用方式如下：

*   **LLM服务**：用于分析小说文本并生成对话JSON。支持两种服务：
    *   **Gemini**：通过Google的Generative Language API调用。在`config.json`中配置`models.gemini`对象，包含`api_key`、`model_name`（如`gemini-2.5-flash`）和`use_proxy`等字段。
    *   **阿里云平台**：通过阿里云百炼平台的通义千问API调用。在`config.json`中配置`models.aliyun`对象，包含`api_key`、`model_name`（如`deepseek-r1`）等字段。
*   **TTS服务**：用于将文本转换为语音。支持三种服务：
    *   **CosyVoice2**：一个本地或局域网部署的TTS服务。在`config.json`中，通过`tts_models.cosyvoice_v2.endpoint`字段配置其API地址（如`http://127.0.0.1:5010/api/tts`）。
    *   **IndexTTS V1.5**：另一个本地或局域网部署的TTS服务。在`config.json`中，通过`tts_models.indextts_v1.5.endpoint`字段配置其API地址（如`http://127.0.0.1:5020/api/tts`）。
    *   **ElevenLabs**：一个云端的高质量TTS服务。其API Key在`config.json`的`elevenlabs.api_key`字段中配置。
*   **STT服务**：用于将上传的语音文件转换为文本。项目集成了**ElevenLabs**的语音识别服务。在`serverV2.py`的`/api/stt_elevenlabs`端点中，使用`requests`库将上传的音频文件转发到`https://api.elevenlabs.io/v1/speech-to-text`，并获取识别结果。

**Section sources**
- [config.json](file://config.json#L26-L44)
- [serverV2.py](file://serverV2.py#L634-L658)
- [serverV2.py](file://serverV2.py#L2413-L2489)

## 依赖库作用与调用位置

以下是项目中关键依赖库的详细说明及其在代码中的调用位置：

*   **FastAPI** (`fastapi`): 作为Web框架，负责处理HTTP请求、定义路由和返回响应。在`serverV2.py`的开头被导入，并用于创建`app`实例和定义所有API端点（如`@app.post("/api/tts_v2")`）。
*   **Pydantic** (`pydantic`): 用于定义API请求和响应的数据模型，实现自动数据验证。在`serverV2.py`中，所有以`class ...Request(BaseModel)`定义的类（如`TTSRequestV2`, `SpliceRequest`）都依赖于此库。
*   **requests**: 用于发起HTTP请求，是与外部AI服务通信的桥梁。在`serverV2.py`中被广泛使用，例如在`generate_with_gemini`函数中调用Gemini API，在`apply_audio_effect`函数中可能调用外部服务，以及在`speech_to_text_elevenlabs`函数中调用ElevenLabs的STT API。
*   **pydub**: 用于音频的高级处理，包括加载、拼接、应用效果和导出。在`serverV2.py`中，`AudioSegment`类被用于`splice_audio`函数中的音频拼接，`normalize`、`low_pass_filter`等函数被用于`apply_audio_effect`函数中实现手机通话、喇叭喊话等特效。
*   **soundfile** (`soundfile as sf`): 用于读写音频文件，提供与`pydub`互补的底层功能。在`serverV2.py`中被导入，虽然在提供的代码片段中未直接调用，但它是处理音频文件的基础库之一。

**Section sources**
- [serverV2.py](file://serverV2.py#L1-L48)

## 依赖安装与运行

要运行本项目，需确保已安装Python环境（建议3.8+）。所有Python依赖包可通过`pip`工具安装。在项目根目录下创建一个`requirements.txt`文件，内容如下：
```
fastapi
pydantic
requests
pydub
soundfile
uvicorn
```
然后执行命令`pip install -r requirements.txt`来安装所有依赖。

项目通过**uvicorn**作为ASGI服务器来运行FastAPI应用。`uvicorn`是运行异步Python Web应用的高性能服务器。在`serverV2.py`文件的末尾，通过`import uvicorn`导入，并在`if __name__ == '__main__':`块中调用`uvicorn.run(app, host=args.host, port=args.port)`来启动服务器。用户也可以通过`启动ServerV2.bat`批处理文件一键启动，该文件会调用`python-3.12.10-embed-amd64\python.exe serverV2.py`。

**Section sources**
- [serverV2.py](file://serverV2.py#L32)
- [serverV2.py](file://serverV2.py#L2525-L2526)
- [启动ServerV2.bat](file://启动ServerV2.bat#L1-L5)

## 配置文件说明

项目的全局配置由`config.json`文件管理。该文件在首次运行时由`serverV2.py`中的`initialize_llm_config()`函数创建默认配置。主要配置项包括：

*   **`general`**: 通用设置。
    *   `default_model`: 默认使用的LLM模型（如`gemini`）。
    *   `proxy`: 代理服务器配置，包含`enabled`、`protocol`、`address`和`port`，用于访问需要代理的外部服务。
    *   `default_tts_model`: 默认使用的TTS模型（如`cosyvoice_v2`）。
*   **`tts_models`**: 定义了所有可用的TTS服务，每个服务包含`display_name`（显示名称）和`endpoint`（API地址）。
*   **`models`**: 定义了所有可用的LLM服务，每个服务包含`display_name`、`model_name`（模型ID）、`api_key`（API密钥）和`use_proxy`（是否使用代理）。
*   **`elevenlabs`**: 存放ElevenLabs服务的`api_key`。

用户可以通过前端的“全局设置”模态框（由`index.html`中的`globalSettingsModal`定义）来修改这些配置，前端会通过`/api/update_llm_config` API将修改后的JSON数据保存回`config.json`文件。

**Section sources**
- [config.json](file://config.json#L1-L45)
- [serverV2.py](file://serverV2.py#L195-L246)
- [serverV2.py](file://serverV2.py#L256-L263)
- [index.html](file://index.html#L566-L673)