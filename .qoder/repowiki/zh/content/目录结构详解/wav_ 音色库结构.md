# wav/ 音色库结构

<cite>
**本文档引用文件**   
- [serverV2.py](file://serverV2.py)
- [index.html](file://index.html)
- [config.json](file://config.json)
</cite>

## 目录
1. [音色库组织方式](#音色库组织方式)
2. [音色文件管理流程](#音色文件管理流程)
3. [音色文件规范与扩展](#音色文件规范与扩展)

## 音色库组织方式

`wav/` 目录作为音色文件的集中管理区，其核心组织逻辑是通过分类（categories）来管理不同的音色。该目录下不直接存放 `.wav` 音频文件，而是以音色名称为名创建子文件夹，每个子文件夹内包含该音色的核心文件。

音色的分类信息并非通过物理的子目录来实现，而是由一个名为 `timbre_categories.json` 的配置文件进行逻辑管理。该文件位于 `wav/` 目录下，其结构如下：
```json
{
  "categories": {
    "男性": ["张三", "李四"],
    "女性": ["王五", "赵六"],
    "儿童": ["小明"],
    "动物": ["狗叫", "猫叫"]
  },
  "unassigned": ["未分类音色A", "未分类音色B"]
}
```
此 JSON 文件包含两个顶级键：
- **`categories`**: 一个字典，其键（key）为分类名称（如“男性”、“女性”），值（value）为该分类下所有音色名称的列表。
- **`unassigned`**: 一个列表，用于存放所有未被分配到任何分类的音色名称。

这种设计将物理文件存储与逻辑分类解耦，使得前端界面可以灵活地创建、删除或重命名分类，而无需移动实际的文件夹，从而提高了操作的效率和安全性。

**Section sources**
- [serverV2.py](file://serverV2.py#L51)
- [serverV2.py](file://serverV2.py#L51)
- [serverV2.py](file://serverV2.py#L2119-L2122)

## 音色文件管理流程

音色文件的上传、分类调整和删除等操作，均由前端 `index.html` 中的音色库管理界面触发，并通过调用 `serverV2.py` 中的 `/timbres` 相关 API 来完成。

### 音色上传流程
1.  **前端操作**：用户点击“上传新音色”按钮，弹出上传模态框。用户需填写音色名称、参考文本，并可选择一个分类。上传的音频文件会被临时保存。
2.  **API 调用**：前端通过 `/api/upload_timbre` 接口提交数据，包括上传的音频文件、音色名称、参考文本、是否进行音量标准化以及目标分类。
3.  **后端处理**：
    *   服务端首先检查音色名称是否已存在。
    *   将上传的音频文件加载为 `AudioSegment` 对象。
    *   根据用户选择，对音频进行音量标准化处理。
    *   将音频统一转换为单声道，并以 `1.wav` 为文件名保存到 `wav/{音色名称}/` 目录下。
    *   将用户输入的参考文本以 `1.txt` 为文件名保存到同一目录。
    *   根据指定的分类，将该音色名称添加到 `timbre_categories.json` 文件的对应分类列表中，若未指定分类则加入 `unassigned` 列表。
    *   最后清理临时文件并返回成功信息。

**Section sources**
- [index.html](file://index.html#L529-L558)
- [index.html](file://index.html#L1679-L1710)
- [serverV2.py](file://serverV2.py#L2225-L2277)

### 分类调整流程
1.  **前端操作**：在音色库管理界面，用户可以为音色选择“移动到”某个分类。前端会动态生成一个包含所有现有分类的菜单供用户选择。
2.  **API 调用**：当用户选择目标分类后，前端调用 `/api/timbres/move` 或 `/api/timbres/set_category` 接口，传入音色名称和目标分类名称。
3.  **后端处理**：
    *   服务端读取 `timbre_categories.json` 文件。
    *   遍历所有分类和 `unassigned` 列表，将该音色名称从其旧位置移除。
    *   将该音色名称添加到新的目标分类列表中（如果目标分类不存在，则会自动创建）。
    *   对列表进行排序以保证一致性。
    *   将更新后的数据写回 `timbre_categories.json` 文件。

**Section sources**
- [index.html](file://index.html#L2495-L2519)
- [serverV2.py](file://serverV2.py#L2194-L2223)

### 音色删除流程
1.  **前端操作**：用户在音色库管理界面选择删除某个音色，并进行确认。
2.  **API 调用**：前端调用 `/api/delete_timbre` 接口，并通过查询参数传入要删除的音色名称。
3.  **后端处理**：
    *   服务端首先在 `timbre_categories.json` 文件中查找该音色名称，并将其从所属的分类或 `unassigned` 列表中移除。
    *   然后，服务端构建该音色的物理路径 `wav/{音色名称}`。
    *   进行严格的安全性检查，确保目标路径在 `wav/` 目录的合法范围内，防止目录遍历攻击。
    *   确认路径有效后，使用 `shutil.rmtree()` 递归删除整个音色文件夹及其所有内容。
    *   操作成功后返回删除成功的消息。

**Section sources**
- [index.html](file://index.html#L2523-L2538)
- [serverV2.py](file://serverV2.py#L2290-L2344)

## 音色文件规范与扩展

### 音色文件命名规范
*   **音色名称**：在上传时由用户自定义，该名称将作为其在 `wav/` 目录下的文件夹名。名称需唯一，不能与现有音色重复。
*   **内部文件**：每个音色文件夹内的音频文件必须命名为 `1.wav`，参考文本文件必须命名为 `1.txt`。这是系统约定的固定命名规则。

### 音频格式要求
为了保证系统处理的一致性和兼容性，上传的音色音频文件需满足以下要求：
*   **采样率**：16kHz
*   **位深度**：16bit
*   **编码**：PCM
*   **声道**：上传后，系统会自动将其转换为**单声道**（Mono）。

### 扩展自定义音色库的操作指南
1.  **上传新音色**：在前端界面点击“上传新音色”，选择符合格式要求的 `.wav` 文件，输入一个唯一的音色名称和一段能体现该音色特点的参考文本（如“你好，我是小明”），并可选择将其归入某个现有分类或保持未分类。
2.  **创建新分类**：在音色库管理界面，可以输入新的分类名称（如“方言”、“机器人”）来创建分类，以便更好地组织音色。
3.  **管理现有音色**：通过“管理音色库”按钮，可以查看所有音色，随时将其移动到不同的分类，或直接删除不再需要的音色。
4.  **在项目中使用**：上传并分类后的音色，会自动出现在前端音色库的列表中。用户可以在“角色-音色配置”或“内容编辑器”中，通过“分配”按钮将这些音色分配给小说中的具体角色。

**Section sources**
- [serverV2.py](file://serverV2.py#L2256-L2258)
- [serverV2.py](file://serverV2.py#L2260-L2262)
- [serverV2.py](file://serverV2.py#L2264-L2265)