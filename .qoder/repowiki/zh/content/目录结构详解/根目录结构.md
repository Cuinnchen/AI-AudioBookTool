# 根目录结构

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [config.json](file://config.json)
- [index.html](file://index.html)
- [style.css](file://style.css)
- [serverV2.py](file://serverV2.py)
- [启动ServerV2.bat](file://启动ServerV2.bat)
</cite>

## 目录
1. [项目介绍与使用指引](#项目介绍与使用指引)
2. [全局配置中心](#全局配置中心)
3. [前端主界面](#前端主界面)
4. [后端服务入口](#后端服务入口)
5. [Windows启动脚本](#windows启动脚本)
6. [用户首次运行交互流程](#用户首次运行交互流程)
7. [常见问题排查](#常见问题排查)

## 项目介绍与使用指引

根据 `README.md` 文件，本项目是一个AI有声书制作工具。其核心功能是利用AI技术将文本小说批量自动化转换为语音文件，从而生成有声书。项目支持两种主要的文本转语音（TTS）模型：Cosyvoice2 和 indexTTS2。在进行角色和对话分析时，项目使用 Gemini 或 Deepseek 模型来智能识别文本中的角色及其对话内容。用户可以通过上传小说文本文件，系统将自动处理并生成对应的音频文件。

**Section sources**
- [README.md](file://README.md#L1-L5)

## 全局配置中心

`config.json` 文件是整个项目的全局配置中心，它以JSON格式定义了系统运行所需的关键参数，主要分为以下几个部分：

1.  **通用设置 (`general`)**：定义了默认使用的AI模型（`default_model`）和TTS模型（`default_tts_model`）。其中，`proxy` 配置项用于设置网络代理，这对于在特定网络环境下访问外部AI服务（如Gemini）至关重要。
2.  **音频导出参数 (`audio_export`)**：控制最终生成的音频文件的格式（`format`）和质量（`quality`），例如配置为MP3格式和256k的比特率。
3.  **TTS模型配置 (`tts_models`)**：这是一个映射表，定义了可用的TTS模型。每个模型都有一个显示名称（`display_name`）和一个指向其服务端点的URL（`endpoint`）。例如，`cosyvoice_v2` 模型的服务地址为 `http://127.0.0.1:5010/api/tts`。
4.  **LLM模型配置 (`models`)**：定义了用于文本分析的AI模型，如Gemini和阿里云平台。每个模型都包含其显示名称、API密钥（`api_key`）、最大处理字符数（`max_chars`）以及是否使用代理（`use_proxy`）等信息。
5.  **其他服务配置 (`elevenlabs`)**：预留了对其他服务（如ElevenLabs）的API密钥配置。

该文件是系统行为的控制核心，所有配置项均可通过前端界面进行修改，并实时影响后端服务的运行。

**Section sources**
- [config.json](file://config.json#L1-L45)

## 前端主界面

`index.html` 是应用的前端主界面，它构建了一个名为“AI 语音工作室 Pro”的一体化工作台。该文件定义了页面的整体结构，包括一个全局头部、一个四列的工作区和多个模态对话框。

工作区的四列分别用于：
- **小说管理与处理**：用户在此上传小说文本、选择处理模型和管理章节。
- **角色-音色配置**：用户在此为识别出的角色分配特定的音色。
- **音色库**：展示所有可用的音色，支持分类和上传新音色。
- **内容编辑器**：显示已处理章节的详细内容，允许用户进行微调和编辑。

页面通过 `<link rel="stylesheet" href="style.css">` 引入了 `style.css` 文件来定义其视觉样式，并通过内联 `<style>` 标签定义了特定于该页面的CSS规则。页面的交互逻辑由内嵌的JavaScript代码控制，这些代码通过 `document.getElementById` 等方法操作DOM元素，实现与后端API的通信。

**Section sources**
- [index.html](file://index.html#L1-L800)

## 后端服务入口

`serverV2.py` 是应用的后端服务入口，基于Python的FastAPI框架构建。它负责处理所有来自前端的HTTP请求，协调文件操作、调用外部AI服务并返回响应。

其主要功能包括：
- **API端点定义**：通过 `@app.get` 和 `@app.post` 装饰器定义了众多API，如 `/api/upload_txt_novel`（上传小说）、`/api/tts_v2`（生成语音）、`/api/splice_audio`（拼接音频）等。
- **文件与目录管理**：在启动时创建必要的目录（如 `projects`, `output`），并处理小说文本、角色配置、音频文件的读写。
- **业务逻辑处理**：实现了核心业务逻辑，例如使用 `generate_chapter_json` 函数调用Gemini或阿里云API分析小说文本，将对话和旁白转换为结构化的JSON数据。
- **外部服务调用**：作为代理，将前端的TTS请求转发给运行在本地的Cosyvoice或IndexTTS微服务。
- **静态文件服务**：通过 `app.mount` 挂载了 `/output` 和 `/wav` 目录，使得生成的音频文件可以通过HTTP直接访问。

该文件是整个应用的“大脑”，所有数据处理和业务逻辑都在此执行。

**Section sources**
- [serverV2.py](file://serverV2.py#L1-L2526)

## Windows启动脚本

`启动ServerV2.bat` 是一个Windows批处理脚本，用于在Windows环境下启动后端服务。其核心作用是通过Uvicorn（一个ASGI服务器）来运行 `serverV2.py` 文件。

脚本内容解析如下：
1.  `@echo off`：关闭命令回显，使执行过程更简洁。
2.  `set PATH=%PATH%;%CD%;%CD%\ffmpeg-8.0-full_build\bin`：将当前目录（`%CD%`）和FFmpeg工具的bin目录添加到系统的PATH环境变量中。这确保了Python脚本可以找到并使用FFmpeg进行音频格式转换。
3.  `call python-3.12.10-embed-amd64\python.exe serverV2.py`：调用项目自带的嵌入式Python解释器来执行 `serverV2.py` 文件，从而启动FastAPI服务。
4.  `call pause`：在服务停止后暂停脚本，防止命令行窗口立即关闭，方便用户查看错误信息。

这个脚本极大地简化了在Windows上的部署和启动流程。

**Section sources**
- [启动ServerV2.bat](file://启动ServerV2.bat#L1-L5)

## 用户首次运行交互流程

当用户首次运行本项目时，各文件的交互流程如下：
1.  **启动服务**：用户双击 `启动ServerV2.bat` 脚本。该脚本首先配置环境变量，然后调用Python解释器执行 `serverV2.py`。
2.  **初始化后端**：`serverV2.py` 开始执行，它会检查 `config.json` 是否存在，若不存在则创建默认配置。随后，它启动Uvicorn服务器，监听指定的端口（默认8000）。
3.  **加载前端**：服务器启动后，会自动将根目录下的 `index.html` 作为静态文件提供服务。用户在浏览器中访问 `http://127.0.0.1:8000` 即可看到前端界面。
4.  **应用配置**：前端页面加载时，会向 `/api/get_llm_config` 发起请求，获取 `config.json` 中的配置，并根据配置填充模型选择下拉框等UI元素。
5.  **开始使用**：用户在前端界面上传小说文本，触发 `/api/upload_txt_novel` 请求。后端接收到请求后，将文本保存到 `projects` 目录，并返回章节列表。用户选择章节后，点击“处理文本”按钮，后端会根据 `config.json` 中的模型配置调用相应的AI服务进行分析。

**Section sources**
- [启动ServerV2.bat](file://启动ServerV2.bat#L1-L5)
- [serverV2.py](file://serverV2.py#L2500-L2526)
- [index.html](file://index.html#L807-L836)
- [config.json](file://config.json#L1-L45)

## 常见问题排查

### 配置未生效
- **问题**：在前端修改了模型或音频导出设置后，新生成的音频未按预期变化。
- **排查**：首先检查 `config.json` 文件是否被成功写入。确认前端发送的API请求（如 `/api/update_llm_config`）是否成功。如果文件已更新但未生效，可能是后端服务需要重启才能加载新配置。

### 页面无法加载
- **问题**：浏览器访问 `http://127.0.0.1:8000` 时显示无法连接。
- **排查**：首先检查 `启动ServerV2.bat` 是否正常运行，观察命令行窗口是否有错误输出。确认端口（默认8000）未被其他程序占用。检查 `serverV2.py` 是否因缺少依赖（如fastapi, uvicorn）而报错。如果服务已启动但页面仍无法加载，检查 `index.html` 文件是否存在于项目根目录。

**Section sources**
- [config.json](file://config.json#L1-L45)
- [serverV2.py](file://serverV2.py#L2500-L2526)
- [index.html](file://index.html#L807-L836)