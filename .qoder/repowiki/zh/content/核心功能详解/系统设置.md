# 系统设置

<cite>
**本文档引用的文件**   
- [config.json](file://config.json)
- [serverV2.py](file://serverV2.py)
- [index.html](file://index.html)
</cite>

## 目录
1. [全局配置管理](#全局配置管理)
2. [替换词典管理](#替换词典管理)
3. [配置热更新机制](#配置热更新机制)
4. [配置文件备份与多环境管理](#配置文件备份与多环境管理)
5. [API密钥安全管理](#api密钥安全管理)

## 全局配置管理

系统通过 `config.json` 文件集中管理全局设置，包括LLM模型、TTS模型、代理服务器等核心配置。前端通过 `renderGlobalSettingsModal` 函数加载并渲染配置，用户可在模态框中进行修改。

`config.json` 文件结构包含多个配置域：
- **general**: 定义默认模型（`default_model`）、默认TTS模型（`default_tts_model`）和代理设置。
- **models**: 定义可用的LLM模型（如Gemini、阿里云），包含其显示名称、API密钥、最大字符数及是否使用代理。
- **tts_models**: 定义可用的TTS模型及其后端服务的API端点。
- **audio_export**: 定义音频导出格式和质量。

用户在前端界面修改配置后，通过 `/api/update_llm_config` API将新的配置数据持久化到 `config.json` 文件中。该API接收一个包含完整配置对象的JSON请求体，并将其写入文件，实现配置的即时保存。

**Section sources**
- [config.json](file://config.json#L1-L45)
- [serverV2.py](file://serverV2.py#L195-L244)
- [index.html](file://index.html#L3012-L3047)

## 替换词典管理

系统支持为每个小说项目管理专属的替换词典，用于在文本预处理阶段替换专有名词或敏感词。替换规则存储在每个小说项目目录下的 `replace_dict.json` 文件中。

前端通过 `loadReplaceDict` 函数从 `/api/novel/{novel_name}/replace_dict` API获取当前小说的替换规则，并在“小说专属替换词典”模态框中展示。用户可以执行以下操作：
- **添加规则**：输入原文和替换词，点击“添加规则”按钮，新规则将被添加到内存中的 `state.replaceDict` 数组。
- **搜索规则**：在搜索框中输入关键词，可实时过滤规则列表。
- **删除规则**：点击规则旁的删除按钮，确认后从列表中移除。

所有对规则的修改都先在前端内存中进行，用户点击“保存全部设置”后，`saveReplaceDict` 函数会将 `state.replaceDict` 数组通过 `/api/novel/{novel_name}/replace_dict` API发送到后端。后端接收到请求后，会验证每条规则的有效性，并将其序列化后写入 `replace_dict.json` 文件。

在TTS生成过程中，`apply_replacement_rules` 函数会加载并应用这些规则。为避免短词影响长词的替换，规则会按原文长度从长到短排序后依次应用。

**Section sources**
- [serverV2.py](file://serverV2.py#L521-L559)
- [serverV2.py](file://serverV2.py#L1959-L1997)
- [index.html](file://index.html#L3871-L3901)
- [index.html](file://index.html#L4029-L4061)

## 配置热更新机制

系统通过 `serverV2.py` 中的配置热更新机制实现了无需重启服务即可生效的设计。该机制的核心在于，所有需要配置信息的API端点（如 `/api/tts_v2` 和 `/api/process_single_chapter`）在每次被调用时，都会动态地从 `config.json` 文件中重新读取最新的配置。

例如，在 `text_to_speech_v2` API中，函数首先通过 `with open(CONFIG_FILE, 'r', encoding='utf-8') as f: config = json.load(f)` 语句加载当前的配置。这意味着，即使用户在服务运行期间修改了 `config.json` 文件，下一次TTS请求时，服务会立即加载并使用新的配置，如新的代理地址或默认TTS模型，从而实现了配置的热更新。

**Section sources**
- [serverV2.py](file://serverV2.py#L1748-L1757)
- [serverV2.py](file://serverV2.py#L562-L564)

## 配置文件备份与多环境管理

为确保配置安全，建议实施以下备份策略：
- **定期备份**：将 `config.json` 和 `projects/` 目录下的 `replace_dict.json` 文件纳入定期备份计划。
- **版本控制**：将整个项目目录（除 `output/` 等生成目录外）纳入Git等版本控制系统，便于追踪配置变更和回滚。

对于多环境配置管理（开发/生产），建议采用以下方法：
- **环境变量**：在 `serverV2.py` 的启动参数中，可以通过命令行参数指定不同的配置文件路径，或使用环境变量来覆盖 `config.json` 中的某些值（如API密钥）。
- **配置文件分离**：维护 `config.dev.json` 和 `config.prod.json` 等不同环境的配置文件，在启动服务时通过参数选择加载哪个文件。

**Section sources**
- [serverV2.py](file://serverV2.py#L2518-L2521)

## API密钥安全管理

系统将API密钥（如 `models.gemini.api_key` 和 `elevenlabs.api_key`）存储在 `config.json` 文件中。为保障密钥安全，应遵循以下最佳实践：
- **文件权限**：确保 `config.json` 文件的文件系统权限设置为仅允许必要用户读取（例如，Linux下使用 `chmod 600 config.json`）。
- **不提交到代码库**：切勿将包含真实密钥的 `config.json` 文件提交到公共代码仓库。应使用 `.gitignore` 忽略该文件，并提供一个 `config.example.json` 作为模板。
- **使用环境变量**：最佳实践是避免在配置文件中硬编码密钥。可以在 `serverV2.py` 中修改代码，优先从环境变量（如 `GEMINI_API_KEY`）读取密钥，如果环境变量不存在，再回退到配置文件中的值。