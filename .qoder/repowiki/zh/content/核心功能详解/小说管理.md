# 小说管理

<cite>
**本文档引用的文件**   
- [index.html](file://index.html)
- [serverV2.py](file://serverV2.py)
</cite>

## 目录
1. [新小说上传流程](#新小说上传流程)
2. [小说列表展示机制](#小说列表展示机制)
3. [删除操作逻辑](#删除操作逻辑)
4. [异常处理与用户反馈](#异常处理与用户反馈)
5. [操作建议与调试技巧](#操作建议与调试技巧)

## 新小说上传流程

新小说的上传流程由前端和后端协同完成。前端通过 `handleTxtFileUpload` 函数监听文件输入事件，当用户选择一个TXT文件后，该函数会被触发。函数内部会创建一个 `FormData` 对象，将文件数据添加进去，并通过 `fetch` 请求向后端的 `/api/upload_txt_novel` API 接口提交。

后端在 `serverV2.py` 文件中定义了 `/api/upload_txt_novel` 接口。该接口接收上传的文件，将其读取并存储在 `projects/` 目录下，以小说名称作为子目录名。在存储文件的同时，系统会生成相应的项目结构，包括创建必要的子目录和元数据文件，为后续的处理和管理做好准备。

**Section sources**
- [index.html](file://index.html#L3364-L3391)
- [serverV2.py](file://serverV2.py#L885-L915)

## 小说列表展示机制

小说列表的展示机制依赖于前后端的数据交互。当用户进入应用或执行刷新操作时，前端会通过 `fetch` 请求向后端的 `/api/list_novels` API 发起一个GET请求。该请求旨在获取服务器上所有已存在的小说项目信息。

后端接收到请求后，会扫描 `projects/` 目录，收集所有子目录（即小说项目）的名称和相关元数据（如创建时间、处理状态等）。这些信息被打包成一个JSON对象并返回给前端。前端接收到响应后，解析JSON数据，并将小说名称动态渲染到UI的选择器（如下拉菜单）中，使用户能够直观地看到所有可用的小说项目并进行选择。

**Section sources**
- [index.html](file://index.html#L1236-L1251)
- [serverV2.py](file://serverV2.py#L885-L915)

## 删除操作逻辑

删除操作是一个关键且不可逆的功能，其逻辑设计注重安全性和完整性。当用户在前端点击“删除”按钮（`deleteNovelBtn`）时，系统会弹出一个确认模态框，要求用户输入“删除”以确认操作，防止误删。

一旦用户确认，前端会向后端的 `/api/delete_novel` API 发起一个DELETE请求，并在查询参数中附带要删除的小说名称。后端接收到请求后，首先会进行安全校验，确保小说名称不包含路径遍历字符（如 `..`），以防止恶意删除系统其他文件。

校验通过后，后端会定位到 `projects/` 目录下的对应小说项目文件夹以及 `output/` 目录下的同名音频输出文件夹。系统使用 `shutil.rmtree()` 函数递归地删除这两个文件夹及其内部的全部内容，从而彻底清除该小说项目的所有相关数据。

**Section sources**
- [index.html](file://index.html#L3298-L3362)
- [serverV2.py](file://serverV2.py#L913-L944)

## 异常处理与用户反馈

系统在设计时充分考虑了异常情况的处理，并提供了清晰的用户反馈机制。

*   **文件重复**：当用户尝试上传一个已存在的小说名称时，后端在创建项目目录时会因目录已存在而失败。此时，后端会抛出一个HTTP 400错误，前端捕获该错误后，会通过全局状态栏（`global-status`）向用户显示“上传失败: [错误信息]”的提示。
*   **路径非法**：在删除操作中，如果用户尝试通过构造恶意名称来删除非项目目录的文件，后端的安全校验会拦截该请求，并返回HTTP 403（禁止访问）错误。前端同样会捕获此错误并向用户发出警告。
*   **用户反馈**：无论是成功还是失败，系统都会通过UI元素向用户反馈结果。成功操作（如上传、删除）会显示绿色的成功提示，而失败操作则会显示红色的错误提示。此外，在执行耗时操作（如处理章节）时，系统会更新进度条和状态信息，让用户了解当前的处理进度。

**Section sources**
- [index.html](file://index.html#L3364-L3391)
- [serverV2.py](file://serverV2.py#L913-L944)

## 操作建议与调试技巧

为了确保操作的顺利进行和便于问题排查，以下是一些建议和技巧：

*   **实际操作截图建议位置**：
    1.  **上传流程**：在“新小说上传流程”章节中，插入一张截图，展示前端的“上传新小说”按钮和文件选择对话框。
    2.  **列表展示**：在“小说列表展示机制”章节中，插入一张截图，展示下拉选择器中已加载的小说列表。
    3.  **删除确认**：在“删除操作逻辑”章节中，插入一张截图，展示删除确认模态框，突出显示输入框和“确认删除”按钮的禁用/启用状态。
*   **调试技巧**：
    1.  **检查日志**：后端的 `serverV2.py` 使用 `logging` 模块记录了详细的操作日志。当功能出现问题时，首先应检查控制台或日志文件中的输出，以定位错误发生的具体位置和原因。
    2.  **验证API端点**：可以使用 `curl` 命令或Postman等工具直接调用 `/api/list_novels` 和 `/api/delete_novel` 等API，验证后端逻辑是否正常工作，从而排除前端代码的干扰。
    3.  **检查文件权限**：确保运行 `serverV2.py` 的用户对 `projects/` 和 `output/` 目录具有读写和删除的权限，权限不足是导致文件操作失败的常见原因。