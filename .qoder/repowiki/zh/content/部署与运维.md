# 部署与运维

<cite>
**本文档引用的文件**   
- [serverV2.py](file://serverV2.py)
- [启动ServerV2.bat](file://启动ServerV2.bat)
- [config.json](file://config.json)
</cite>

## 目录
1. [生产环境部署建议](#生产环境部署建议)
2. [启动脚本详解](#启动脚本详解)
3. [服务日志查看](#服务日志查看)
4. [健康检查方法](#健康检查方法)
5. [常见问题与解决方案](#常见问题与解决方案)
6. [数据备份建议](#数据备份建议)
7. [Docker化部署思路](#docker化部署思路)

## 生产环境部署建议

为了确保AI有声书工具在生产环境中的稳定性、安全性和性能，建议采用以下部署方案。

### 使用Nginx反向代理

在生产环境中，不建议直接暴露FastAPI应用。应使用Nginx作为反向代理服务器，其优势包括：
*   **安全性**：隐藏后端服务器的真实IP和端口。
*   **负载均衡**：可轻松扩展为多实例部署。
*   **静态文件服务**：高效地提供前端HTML、CSS、JS等静态资源。
*   **SSL/TLS终止**：集中管理HTTPS证书。

**Nginx配置示例**：
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 反向代理到后端FastAPI服务
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件路径，根据实际项目结构调整
    location /output/ {
        alias /path/to/your/AI-AudioBookTool/output/;
    }
    
    location /wav/ {
        alias /path/to/your/AI-AudioBookTool/wav/;
    }
}
```

### 配置Gunicorn+Uvicorn工作进程

直接使用`uvicorn.run()`（如`serverV2.py`中所示）适用于开发，但在生产环境中，应使用Gunicorn作为进程管理器来管理多个Uvicorn工作进程，以实现并发处理。

**安装Gunicorn**：
```bash
pip install gunicorn
```

**使用Gunicorn启动服务**：
```bash
gunicorn -k uvicorn.workers.UvicornWorker -w 4 -b 127.0.0.1:8000 serverV2:app
```
*   `-k uvicorn.workers.UvicornWorker`：指定使用Uvicorn工作进程。
*   `-w 4`：启动4个工作进程，可根据服务器CPU核心数调整。
*   `-b 127.0.0.1:8000`：绑定到本地8000端口。
*   `serverV2:app`：指定模块名和FastAPI应用实例。

### 设置日志轮转

`serverV2.py`文件中使用了`logging.basicConfig()`，但未配置日志轮转。在生产环境中，应使用`logging.handlers.RotatingFileHandler`或`TimedRotatingFileHandler`来防止日志文件无限增长。

**修改建议**：
在`serverV2.py`的`# --- 基本配置和目录定义 ---`部分，将`logging.basicConfig()`替换为：
```python
import logging
from logging.handlers import RotatingFileHandler

# 创建一个日志器
logger = logging.getLogger('AI-AudioBookTool')
logger.setLevel(logging.INFO)

# 创建一个文件处理器，最大10MB，保留5个备份
handler = RotatingFileHandler('app.log', maxBytes=10*1024*1024, backupCount=5)
formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
handler.setFormatter(formatter)

# 将处理器添加到日志器
logger.addHandler(handler)
```

**Section sources**
- [serverV2.py](file://serverV2.py#L37-L38)

## 启动脚本详解

`启动ServerV2.bat`是Windows系统下的批处理脚本，用于启动后端服务。其内容如下：

```batch
@echo off
set PATH=%PATH%;%CD%;%CD%\ffmpeg-8.0-full_build\bin
call python-3.12.10-embed-amd64\python.exe serverV2.py
call pause
```

**逐行解释**：
1.  **`@echo off`**：关闭命令回显，使脚本执行时只显示输出结果，不显示命令本身。
2.  **`set PATH=%PATH%;%CD%;%CD%\ffmpeg-8.0-full_build\bin`**：将当前目录（`%CD%`）和`ffmpeg-8.0-full_build\bin`子目录添加到系统的`PATH`环境变量中。这确保了脚本在执行时，可以找到并调用`ffmpeg.exe`，该程序是`pydub`库进行音频格式转换所必需的。
3.  **`call python-3.12.10-embed-amd64\python.exe serverV2.py`**：调用项目目录下的嵌入式Python解释器（`python-3.12.10-embed-amd64\python.exe`）来执行`serverV2.py`文件，从而启动FastAPI后端服务。
4.  **`call pause`**：暂停脚本执行，等待用户按键。这使得在Windows双击运行时，即使服务因错误而退出，控制台窗口也不会立即关闭，方便用户查看错误日志。

**Section sources**
- [启动ServerV2.bat](file://启动ServerV2.bat#L1-L5)

## 服务日志查看

服务日志是诊断问题的关键，主要分为两种：

### Console输出
服务启动后，所有通过`print()`和`logger.info()`等函数输出的信息都会直接显示在运行`启动ServerV2.bat`或`gunicorn`命令的控制台窗口中。这是最直接的实时日志查看方式。

### 文件日志
根据`serverV2.py`中的`logging.basicConfig()`配置，日志信息会输出到控制台。如上文所述，若配置了`RotatingFileHandler`，则日志将被写入指定的文件（如`app.log`），便于长期保存和分析。

### 常见错误信息识别
*   **端口占用**：如果启动时出现类似`OSError: [Errno 98] Address already in use`的错误，说明8000端口已被其他程序占用。解决方案是使用`netstat -ano | findstr :8000`查找占用端口的进程并结束它，或修改`serverV2.py`中的默认端口。
*   **API密钥无效**：在调用LLM（如Gemini）或TTS服务时，如果返回`401 Unauthorized`或`API Key 未在配置文件中设置`，请检查`config.json`文件中对应模型的`api_key`字段是否正确填写。
*   **TTS服务不可达**：当后端尝试调用TTS微服务（如`http://127.0.0.1:5010/api/tts`）时，如果该服务未启动，日志中会出现`调用 TTS 微服务失败: ... Connection refused`。请确保TTS服务已正确启动。

**Section sources**
- [serverV2.py](file://serverV2.py#L37-L38)
- [serverV2.py](file://serverV2.py#L1730-L1862)
- [config.json](file://config.json#L27-L40)

## 健康检查方法

为了确认服务是否正常运行，可以进行以下健康检查：

1.  **访问根路径**：在浏览器中打开 `http://localhost:8000`（或您配置的域名和端口）。如果服务正常，您应该能看到前端的HTML页面。
2.  **调用API接口**：访问 `http://localhost:8000/api/list_novels`。如果服务正常，该接口会返回一个JSON响应，其中包含`novels_details`字段，即使当前没有项目，其值也应为一个空对象`{}`。如果返回`404 Not Found`或连接超时，则服务未正常启动。

**Section sources**
- [serverV2.py](file://serverV2.py#L1610-L1664)

## 常见问题与解决方案

### 服务无法启动
*   **现象**：双击`启动ServerV2.bat`后，窗口一闪而过或报错。
*   **排查步骤**：
    1.  检查**端口**：确认8000端口是否被占用。
    2.  检查**依赖**：确保`python-3.12.10-embed-amd64`目录存在且`python.exe`可执行。检查`requirements.txt`中的Python包（如`fastapi`, `uvicorn`, `pydub`）是否已通过`pip install -r requirements.txt`安装。
    3.  查看**日志**：根据`call pause`的提示，观察控制台输出的错误信息。

### 上传失败
*   **现象**：在前端上传小说文本或音色文件时失败。
*   **原因与解决**：最常见的原因是**目录权限**。确保运行服务的用户对`projects/`和`wav/`目录有读写权限。在Windows上，通常需要以管理员身份运行脚本或确保文件夹未被锁定。

### 生成语音无声音
*   **现象**：TTS生成的WAV文件存在，但播放时无声。
*   **原因与解决**：这通常是因为**TTS服务连接**问题。检查`config.json`中的`"tts_models"`配置项，确认`endpoint`地址（如`http://127.0.0.1:5010/api/tts`）是否正确，并且对应的TTS微服务（如CosyVoice）正在运行。

### 拼接失败
*   **现象**：点击“拼接”按钮后，最终音频文件未生成。
*   **原因与解决**：拼接功能依赖`pydub`库，而`pydub`需要`ffmpeg`来处理音频。请检查`启动ServerV2.bat`脚本是否成功将`ffmpeg.exe`的路径添加到了`PATH`中。在`serverV2.py`启动时，会输出`成功为 pydub 定位到 ffmpeg.exe`的日志，如果没有此日志，则说明`ffmpeg`未找到，需要检查`ffmpeg-8.0-full_build`目录是否存在。

**Section sources**
- [serverV2.py](file://serverV2.py#L2505-L2526)
- [启动ServerV2.bat](file://启动ServerV2.bat#L2)
- [serverV2.py](file://serverV2.py#L1864-L1957)
- [config.json](file://config.json#L16-L24)

## 数据备份建议

项目中的`projects/`和`wav/`目录包含了用户的核心数据：
*   `projects/`：存储了所有小说的源文本、处理后的JSON章节、角色配置等。
*   `wav/`：存储了所有可用的音色样本。

**建议**：定期（例如每天或每周）对这两个目录进行备份。可以使用简单的文件复制，或使用`rsync`、`robocopy`等工具进行增量备份，以防因硬件故障或误操作导致数据丢失。

**Section sources**
- [serverV2.py](file://serverV2.py#L40-L45)

## Docker化部署思路

对于高级用户，可以将应用容器化，以实现环境隔离和便捷部署。

### Dockerfile示例
```dockerfile
FROM python:3.12-slim

WORKDIR /app

# 复制项目文件
COPY . .

# 安装系统依赖（ffmpeg）
RUN apt-get update && apt-get install -y ffmpeg && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["gunicorn", "-k", "uvicorn.workers.UvicornWorker", "-w", "4", "-b", "0.0.0.0:8000", "serverV2:app"]
```

### docker-compose.yml示例
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./projects:/app/projects
      - ./wav:/app/wav
      - ./output:/app/output
    environment:
      - PYTHONPATH=/app
```

此配置将构建应用镜像，启动一个容器，并将宿主机的`projects/`, `wav/`, `output/`目录挂载到容器内，确保数据持久化。